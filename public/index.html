<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BananaChat - Sohbet Et!</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #0f0f0f;
            min-height: 100vh;
            color: #e2e8f0;
            position: relative;
            overflow-x: hidden;
        }

        /* Muz arka plan deseni */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><pattern id="bananas" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><g opacity="0.1"><path d="M20,30 Q25,15 35,20 Q45,25 40,40 Q35,55 25,50 Q15,45 20,30 Z" fill="%23ffc107"/><path d="M60,70 Q65,55 75,60 Q85,65 80,80 Q75,95 65,90 Q55,85 60,70 Z" fill="%23ff8f00"/><path d="M10,80 Q15,65 25,70 Q35,75 30,90 Q25,105 15,100 Q5,95 10,80 Z" fill="%23ffeb3b"/><path d="M70,20 Q75,5 85,10 Q95,15 90,30 Q85,45 75,40 Q65,35 70,20 Z" fill="%23ffc107"/></g></pattern></defs><rect width="100%" height="100%" fill="url(%23bananas)"/></svg>');
            background-size: 200px 200px;
            animation: floatBananas 30s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
            filter: blur(1px);
            opacity: 0.3;
        }

        @keyframes floatBananas {
            0%, 100% { transform: translateY(0px) translateX(0px) rotate(0deg); }
            25% { transform: translateY(-10px) translateX(5px) rotate(1deg); }
            50% { transform: translateY(-20px) translateX(-5px) rotate(-1deg); }
            75% { transform: translateY(-10px) translateX(5px) rotate(1deg); }
        }

        .container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Auth Styles */
        .auth-card {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(15px);
        }

        .logo {
            margin-bottom: 30px;
        }

        .banana {
            font-size: 3rem;
            display: block;
            margin-bottom: 10px;
        }

        .logo h1 {
            color: #ffc107;
            font-weight: 600;
            font-size: 2rem;
            text-shadow: 0 2px 10px rgba(255, 193, 7, 0.3);
        }

        .auth-form h2 {
            margin-bottom: 25px;
            color: #e2e8f0;
            font-weight: 500;
        }

        .auth-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: rgba(0, 0, 0, 0.8);
            color: #e2e8f0;
        }

        .auth-form input::placeholder {
            color: #94a3b8;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #ffc107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn.primary {
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            color: #1a202c;
            width: 100%;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .btn.primary:hover {
            background: linear-gradient(135deg, #ffeb3b 0%, #ffc107 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        .btn.secondary {
            background: rgba(71, 85, 105, 0.8);
            color: #e2e8f0;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .btn.secondary:hover {
            background: rgba(100, 116, 139, 0.8);
            border-color: rgba(255, 193, 7, 0.4);
        }

        .btn.small {
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
        }

        .auth-form p {
            margin-top: 20px;
            color: #94a3b8;
        }

        .auth-form a {
            color: #ffc107;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-form a:hover {
            text-decoration: underline;
            color: #ffeb3b;
        }

        /* Chat Layout */
        .chat-layout {
            display: flex;
            width: 100%;
            max-width: 1200px;
            height: 80vh;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(15px);
        }

        .sidebar {
            width: 320px;
            background: rgba(0, 0, 0, 0.8);
            border-right: 1px solid rgba(255, 193, 7, 0.3);
            display: flex;
            flex-direction: column;
        }

        .user-info {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 193, 7, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 193, 7, 0.05);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #1a202c;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .user-details {
            flex: 1;
        }

        .user-details span {
            display: block;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .user-status {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 8px !important;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .friends-section {
            flex: 1;
            padding: 20px;
        }

        .groups-section {
            padding: 20px;
            border-top: 1px solid rgba(255, 193, 7, 0.3);
        }

        .groups-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px; /* Butonlar ve başlık arasında boşluk */
            flex-wrap: nowrap; /* Sarmalamayı engelle */
        }

        .section-header h3 {
            color: #e2e8f0;
            font-weight: 500;
            flex-shrink: 1; /* Başlığın küçülmesine izin ver */
            min-width: 0; /* Flexbox overflow için */
            font-size: 16px; /* Başlığı biraz küçült */
        }

        .header-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0; /* Butonların küçülmesini engelle */
        }

        .header-actions .btn.small {
            padding: 6px 10px;
            font-size: 12px;
            min-width: 32px;
            white-space: nowrap;
        }

        /* Arkadaş Profili Stilleri */
        .friend-profile-avatar-section {
            display: flex;
            align-items: center;
            gap: 20px;
            text-align: left;
        }

        .friend-profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #1a202c;
            background-size: cover;
            background-position: center;
            border: 3px solid rgba(255, 193, 7, 0.3);
            flex-shrink: 0;
        }

        .friend-profile-info h2 {
            margin: 0 0 5px 0;
            color: #e2e8f0;
            font-size: 24px;
        }

        .friend-profile-info p {
            margin: 0 0 10px 0;
            color: #94a3b8;
            font-size: 16px;
        }

        .friend-profile-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .friend-profile-status.online {
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
        }

        .friend-profile-status.away {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
        }

        .friend-profile-status.busy {
            background: rgba(245, 101, 101, 0.2);
            color: #f56565;
        }

        .friend-profile-status.invisible {
            background: rgba(160, 174, 192, 0.2);
            color: #a0aec0;
        }

        .friend-profile-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .friend-profile-actions .btn {
            flex: 1;
            min-width: 150px;
        }

        /* Grup Oluşturma Stilleri */
        .friends-selection {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            /* Scrollbar'ı gizle */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        .friends-selection::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        .friend-checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .friend-checkbox-item:hover {
            background: rgba(255, 193, 7, 0.1);
        }

        .friend-checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #ffc107;
        }

        .friend-checkbox-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 193, 7, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #e2e8f0;
            background-size: cover;
            background-position: center;
        }

        .friend-checkbox-info {
            flex: 1;
        }

        .friend-checkbox-name {
            color: #e2e8f0;
            font-weight: 500;
            font-size: 14px;
        }

        .friend-checkbox-username {
            color: #94a3b8;
            font-size: 12px;
        }

        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .friend-item {
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 193, 7, 0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        /* Bildirim badge */
        .friend-item .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .friend-item:hover {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
            transform: translateX(5px);
        }

        .friend-item.active {
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            color: #1a202c;
            border-color: #ffc107;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 193, 7, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #e2e8f0;
        }

        .friend-item.active .friend-avatar {
            background: rgba(26, 32, 44, 0.2);
            color: #1a202c;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .friend-status {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.9);
            min-height: 0; /* Flexbox overflow için */
        }

        .active-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.9);
            min-height: 0; /* Flexbox overflow için */
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 193, 7, 0.3);
            background: rgba(0, 0, 0, 0.95) !important;
            position: relative;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .group-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .group-name {
            font-weight: 500;
            font-size: 18px;
            color: #e2e8f0;
        }

        .group-members-summary {
            font-size: 12px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .members-toggle {
            background: none;
            border: none;
            color: #ffc107;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .members-toggle:hover {
            background: rgba(255, 193, 7, 0.1);
        }

        .group-members-panel {
            position: absolute;
            top: 100%;
            right: 20px;
            width: 300px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            backdrop-filter: blur(15px);
            /* Scrollbar'ı gizle */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        .group-members-panel::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        .members-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 193, 7, 0.2);
        }

        .members-panel-title {
            color: #e2e8f0;
            font-weight: 500;
            font-size: 16px;
        }

        .close-members-panel {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-members-panel:hover {
            color: #e2e8f0;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background-color 0.3s;
        }

        .member-item:hover {
            background: rgba(255, 193, 7, 0.1);
        }

        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 193, 7, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #e2e8f0;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .member-status-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid rgba(0, 0, 0, 0.9);
        }

        .member-status-indicator.online {
            background: #48bb78;
        }

        .member-status-indicator.away {
            background: #ed8936;
        }

        .member-status-indicator.busy {
            background: #f56565;
        }

        .member-status-indicator.offline {
            background: #a0aec0;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            color: #e2e8f0;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .member-username {
            color: #94a3b8;
            font-size: 12px;
        }

        .member-role {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }

        .online-count {
            color: #48bb78;
            font-weight: 500;
        }

        .offline-count {
            color: #a0aec0;
        }

        /* Yazıyor Göstergesi */
        .typing-indicator {
            padding: 10px 20px;
            font-size: 14px;
            color: #94a3b8;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-dots {
            display: flex;
            gap: 2px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Mesaj Yanıtlama */
        .reply-preview {
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reply-content {
            flex: 1;
        }

        .reply-to {
            font-size: 12px;
            color: #ffc107;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .reply-text {
            font-size: 14px;
            color: #e2e8f0;
            opacity: 0.8;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .reply-close {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reply-close:hover {
            color: #e2e8f0;
        }

        .message-reply {
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 0 6px 6px 0;
            font-size: 12px;
        }

        .reply-author {
            color: #ffc107;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .reply-message {
            color: #e2e8f0;
            opacity: 0.8;
        }

        /* Mesaj Sabitleme - KALDIRILDI */
        .pinned-messages {
            display: none !important;
        }

        /* Okundu Bilgisi */
        .message-status {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
        }

        .read-status {
            font-size: 12px;
            color: #48bb78;
        }

        .unread-status {
            font-size: 12px;
            color: #94a3b8;
        }

        /* Arkadaş İstekleri */
        .friend-requests-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 193, 7, 0.3);
        }

        .friend-request-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .request-actions {
            display: flex;
            gap: 8px;
        }

        .request-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Banner Profil */
        .profile-banner {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            background-size: cover;
            background-position: center;
        }

        .banner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .profile-banner:hover .banner-overlay {
            opacity: 1;
        }

        .banner-actions {
            display: flex;
            gap: 10px;
        }

        .banner-btn {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .banner-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        /* Nitro Özellikleri */
        .nitro-badge {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Engellenen Kullanıcılar */
        .blocked-users-list {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .blocked-users-list::-webkit-scrollbar {
            display: none;
        }

        .blocked-user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid rgba(245, 101, 101, 0.3);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .blocked-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(245, 101, 101, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #e2e8f0;
            background-size: cover;
            background-position: center;
        }

        .blocked-user-info {
            flex: 1;
        }

        .blocked-user-name {
            color: #e2e8f0;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .blocked-user-username {
            color: #94a3b8;
            font-size: 12px;
        }

        .unblock-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .unblock-btn:hover {
            background: #38a169;
        }

        .nitro-features {
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            background: rgba(255, 193, 7, 0.05);
        }

        .nitro-title {
            color: #ffc107;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nitro-feature {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .nitro-icon {
            color: #ffc107;
            font-size: 16px;
        }

        /* Bildirim Animasyonları */
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
            backdrop-filter: blur(15px);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .notification-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #1a202c;
        }

        .notification-title {
            color: #e2e8f0;
            font-weight: 500;
            font-size: 14px;
        }

        .notification-message {
            color: #94a3b8;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Emoji Picker ve GIF Panel */
        .message-input-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 193, 7, 0.3);
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.5);
            position: relative;
            flex-shrink: 0; /* Input alanının küçülmesini engelle */
        }

        .input-container {
            flex: 1;
            position: relative;
        }

        .message-input-area input {
            flex: 1;
            padding: 15px 50px 15px 15px;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            background: rgba(0, 0, 0, 0.8);
            color: #e2e8f0;
            width: 100%;
        }

        .input-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px;
        }

        .input-action-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            font-size: 18px;
            transition: all 0.2s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-action-btn:hover {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        /* Resim upload */
        .image-upload-input {
            display: none;
        }

        /* Mesaj içinde resim */
        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            margin: 5px 0;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        /* Resim önizleme modal */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .image-preview-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .image-preview-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }

        .image-preview-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-preview-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Resim yükleme durumu */
        .image-uploading {
            opacity: 0.7;
            pointer-events: none;
        }

        .upload-progress {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
        }

        .emoji-gif-panel {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 350px;
            height: 400px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(15px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 193, 7, 0.2);
        }

        .panel-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .panel-tab.active {
            color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .panel-tab:hover {
            background: rgba(255, 193, 7, 0.05);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            /* Scrollbar'ı gizle */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        .panel-content::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        /* Emoji Grid */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .emoji-item {
            background: none;
            border: none;
            font-size: 24px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-item:hover {
            background: rgba(255, 193, 7, 0.1);
        }

        /* GIF Search */
        .gif-search {
            margin-bottom: 15px;
        }

        .gif-search input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: #e2e8f0;
            font-size: 14px;
        }

        .gif-search input:focus {
            outline: none;
            border-color: #ffc107;
        }

        .gif-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .gif-item {
            background: none;
            border: none;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            aspect-ratio: 1;
        }

        .gif-item:hover {
            transform: scale(1.05);
        }

        .gif-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gif-loading {
            text-align: center;
            color: #94a3b8;
            padding: 20px;
        }

        /* Mesaj içinde GIF ve emoji */
        .message-gif {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin: 5px 0;
        }

        .message-emoji {
            font-size: 24px;
            margin: 0 2px;
        }

        /* Mesaj Context Menu */
        .message-context-menu {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 5px 0;
            z-index: 10000;
            min-width: 120px;
            backdrop-filter: blur(15px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .context-menu-item {
            padding: 8px 15px;
            color: #e2e8f0;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background: rgba(255, 193, 7, 0.1);
        }

        .context-menu-item.danger {
            color: #f56565;
        }

        .context-menu-item.danger:hover {
            background: rgba(245, 101, 101, 0.1);
        }

        /* Discord tarzı mesaj hover efekti */
        .message {
            position: relative;
            transition: background-color 0.3s;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 8px 12px;
        }

        .message:hover {
            background: rgba(255, 193, 7, 0.05);
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.sent:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .message.received {
            align-self: flex-start;
            background: rgba(71, 85, 105, 0.8);
            color: #e2e8f0;
            border-bottom-left-radius: 4px;
        }

        .message.received:hover {
            background: rgba(100, 116, 139, 0.8);
        }

        .message.deleting {
            opacity: 0.5;
            pointer-events: none;
        }

        .message-deleted {
            font-style: italic;
            opacity: 0.6;
            color: #94a3b8 !important;
        }

        /* Discord tarzı mesaj aksiyonları */
        .message-actions {
            position: absolute;
            top: -8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 6px;
            padding: 4px;
            display: flex;
            gap: 4px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .message:hover .message-actions {
            opacity: 1;
            visibility: visible;
        }

        .message-action-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .message-action-btn:hover {
            background: rgba(255, 193, 7, 0.1);
            color: #e2e8f0;
        }

        .message-action-btn.delete:hover {
            background: rgba(245, 101, 101, 0.2);
            color: #f56565;
        }

        /* Mesaj içeriği */
        .message-content {
            position: relative;
        }

        .message-text {
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .message-sender {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .chat-user-info .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #1a202c;
        }

        .chat-user-info span {
            font-weight: 500;
            font-size: 18px;
            color: #e2e8f0;
        }

        .no-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 193, 7, 0.3);
            background: rgba(0, 0, 0, 0.8);
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3);
            min-height: 0; /* Flexbox overflow için */
        }

        /* Mesaj container'ı için özel scrollbar */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(255, 193, 7, 0.3);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 193, 7, 0.5);
        }

        .message-input-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 193, 7, 0.3);
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.5);
        }

        .message-input-area input {
            flex: 1;
            padding: 15px;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            background: rgba(0, 0, 0, 0.8);
            color: #e2e8f0;
        }

        .banana-big {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .active-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-user-info span {
            font-weight: 500;
            font-size: 18px;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.sent {
            align-self: flex-end;
            background: #667eea;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            align-self: flex-start;
            background: #e2e8f0;
            color: #4a5568;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .message-input-area {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 15px;
        }

        .message-input-area input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .message-input-area input:focus {
            border-color: #667eea;
        }

        .message-input-area .btn {
            border-radius: 20px;
            padding: 12px 16px;
            min-width: 70px;
            width: auto;
            flex-shrink: 0;
            font-size: 14px;
        }

        /* Alert Modal */
        .alert-modal {
            max-width: 400px;
            animation: alertSlideIn 0.3s ease-out;
            z-index: 10000; /* En üstte görünsün */
        }

        .modal.alert-modal-container {
            z-index: 10000 !important; /* Alert modal container'ı da en üstte */
        }

        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .alert-header {
            padding: 20px 20px 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alert-icon.info {
            background: #e6fffa;
            color: #667eea;
        }

        .alert-icon.success {
            background: #f0fff4;
            color: #48bb78;
        }

        .alert-icon.warning {
            background: #fffbeb;
            color: #ed8936;
        }

        .alert-icon.error {
            background: #fed7d7;
            color: #f56565;
        }

        .alert-header h3 {
            margin: 0;
            color: #4a5568;
            font-size: 18px;
        }

        .alert-body {
            padding: 0 20px 20px 20px;
        }

        .alert-body p {
            margin: 0;
            color: #4a5568;
            line-height: 1.5;
        }

        .alert-actions {
            padding: 0 20px 20px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .alert-actions .btn {
            min-width: 80px;
        }

        .modal-content {
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
            backdrop-filter: blur(15px);
        }

        .modal-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid rgba(255, 193, 7, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.8);
            color: #e2e8f0;
        }

        .profile-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 193, 7, 0.2);
            background: rgba(0, 0, 0, 0.8);
        }

        .profile-section h4 {
            margin: 0 0 15px 0;
            color: #ffc107;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #e2e8f0;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: rgba(0, 0, 0, 0.9);
            color: #e2e8f0;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #94a3b8;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ffc107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }

        .form-group input:disabled {
            background: rgba(0, 0, 0, 0.5);
            color: #94a3b8;
            cursor: not-allowed;
            border-color: rgba(255, 193, 7, 0.1);
        }

        .username-input {
            display: flex;
            align-items: center;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            transition: border-color 0.3s;
            background: rgba(0, 0, 0, 0.9);
        }

        .username-input:focus-within {
            border-color: #ffc107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }

        .username-prefix {
            padding: 12px 8px 12px 12px;
            background: rgba(0, 0, 0, 0.7);
            color: #ffc107;
            font-weight: 500;
            border-right: 1px solid rgba(255, 193, 7, 0.2);
        }

        .username-input input {
            border: none;
            padding: 12px 12px 12px 8px;
            flex: 1;
            background: transparent;
        }

        .username-input input:focus {
            border: none;
            box-shadow: none;
        }

        .help-text {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 5px;
            margin-bottom: 0;
        }

        .char-count {
            text-align: right;
            font-size: 12px;
            color: #94a3b8;
            margin-top: 5px;
        }

        .status-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .status-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 193, 7, 0.1);
        }

        .status-option:hover {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
        }

        .status-option.active {
            background: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
        }

        .status-option span {
            color: #e2e8f0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-indicator.online {
            background: #48bb78;
        }

        .status-indicator.away {
            background: #ed8936;
        }

        .status-indicator.busy {
            background: #f56565;
        }

        .status-indicator.invisible {
            background: #a0aec0;
        }

        .profile-actions {
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid rgba(255, 193, 7, 0.2);
        }

        .current-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #1a202c;
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255, 193, 7, 0.3);
        }

        .avatar-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
        }

        .avatar-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Alert modal'ı diğer modal'lardan daha üstte göster */
        .modal#alert-modal {
            z-index: 10000 !important;
            background: rgba(0,0,0,0.7); /* Daha koyu arka plan */
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .profile-modal {
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            /* Scrollbar'ı gizle */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        .profile-modal::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        .modal-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid rgba(255, 193, 7, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #e2e8f0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #a0aec0;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #4a5568;
        }

        .modal-body {
            padding: 20px;
        }

        .profile-body {
            padding: 0;
        }

        .profile-section {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .profile-section:last-child {
            border-bottom: none;
        }

        .profile-section h4 {
            margin: 0 0 15px 0;
            color: #4a5568;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .avatar-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
        }

        .current-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            background-size: cover;
            background-position: center;
        }

        .avatar-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input:disabled {
            background: #f8fafc;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .username-input {
            display: flex;
            align-items: center;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .username-input:focus-within {
            border-color: #667eea;
        }

        .username-prefix {
            padding: 12px 8px 12px 12px;
            background: #f8fafc;
            color: #a0aec0;
            font-weight: 500;
        }

        .username-input input {
            border: none;
            padding: 12px 12px 12px 0;
            flex: 1;
        }

        .username-input input:focus {
            border: none;
        }

        .help-text {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 5px;
            margin-bottom: 0;
        }

        .char-count {
            text-align: right;
            font-size: 12px;
            color: #a0aec0;
            margin-top: 5px;
        }

        .status-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .status-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .status-option:hover {
            background: #f8fafc;
        }

        .status-option.active {
            background: #e6fffa;
            border: 2px solid #667eea;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-indicator.online {
            background: #48bb78;
        }

        .status-indicator.away {
            background: #ed8936;
        }

        .status-indicator.busy {
            background: #f56565;
        }

        .status-indicator.invisible {
            background: #a0aec0;
        }

        .profile-actions {
            padding: 20px;
            background: #f8fafc;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-body input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
        }

        .modal-body input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chat-layout {
                height: 90vh;
            }
            
            .sidebar {
                width: 270px;
            }
            
            .container {
                padding: 10px;
            }
        }

        @media (max-width: 600px) {
            .chat-layout {
                flex-direction: column;
                height: 100vh;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .friends-section {
                padding: 10px;
            }
            
            .friends-list {
                flex-direction: row;
                overflow-x: auto;
                gap: 10px;
            }
            
            .friend-item {
                min-width: 120px;
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Giriş/Kayıt Sayfası -->
    <div id="auth-container" class="container">
        <div class="auth-card">
            <div class="logo">
                <span class="banana">🍌</span>
                <h1>BananaChat</h1>
            </div>
            
            <!-- Giriş Formu -->
            <div id="login-form" class="auth-form">
                <h2>Giriş Yap</h2>
                <input type="email" id="login-email" placeholder="E-posta" required>
                <input type="password" id="login-password" placeholder="Şifre" required>
                <button id="login-btn" class="btn primary">Giriş Yap</button>
                <p>Hesabın yok mu? <a href="#" id="show-register">Kayıt ol</a></p>
            </div>
            
            <!-- Kayıt Formu -->
            <div id="register-form" class="auth-form hidden">
                <h2>Kayıt Ol</h2>
                <input type="text" id="register-name" placeholder="Adın" required>
                <input type="email" id="register-email" placeholder="E-posta" required>
                <input type="password" id="register-password" placeholder="Şifre (min 6 karakter)" required>
                <button id="register-btn" class="btn primary">Kayıt Ol</button>
                <p>Zaten hesabın var mı? <a href="#" id="show-login">Giriş yap</a></p>
            </div>
        </div>
    </div>

    <!-- Ana Sohbet Sayfası -->
    <div id="chat-container" class="container hidden">
        <div class="chat-layout">
            <!-- Sol Panel - Arkadaşlar -->
            <div class="sidebar">
                <div class="user-info">
                    <div class="user-avatar" id="current-user-avatar">👤</div>
                    <div class="user-details">
                        <span id="current-user-name">Kullanıcı</span>
                        <span id="current-user-status" class="user-status">Çevrimiçi</span>
                        <div class="user-actions">
                            <button id="edit-profile-btn" class="btn secondary small" onclick="window.openProfile()">Profil</button>
                            <button id="logout-btn" class="btn secondary small">Çıkış</button>
                        </div>
                    </div>
                </div>
                
                <div class="friends-section">
                    <!-- Arkadaş İstekleri Bölümü -->
                    <div id="friend-requests-section" class="friend-requests-section hidden">
                        <div class="section-header">
                            <h3>Arkadaş İstekleri</h3>
                            <button id="close-requests-btn" class="btn secondary small">Kapat</button>
                        </div>
                        <div id="friend-requests-list">
                            <!-- Arkadaş istekleri buraya gelecek -->
                        </div>
                    </div>

                    <div class="section-header">
                        <h3>Arkadaşlar</h3>
                        <div class="header-actions">
                            <button id="show-requests-btn" class="btn secondary small" title="Arkadaş İstekleri">📬</button>
                            <button id="create-group-btn-header" class="btn primary small" title="Grup Oluştur">👥</button>
                            <button id="add-friend-btn" class="btn primary small" title="Arkadaş Ekle">+</button>
                        </div>
                    </div>
                    <div id="friends-list" class="friends-list">
                        <!-- Arkadaşlar buraya gelecek -->
                    </div>
                </div>

                <!-- Gruplar Bölümü -->
                <div class="groups-section">
                    <div class="section-header">
                        <h3>Gruplar</h3>
                    </div>
                    <div id="groups-list" class="groups-list">
                        <!-- Gruplar buraya gelecek -->
                    </div>
                </div>
            </div>
            
            <!-- Sağ Panel - Sohbet -->
            <div class="chat-area">
                <div id="no-chat" class="no-chat">
                    <span class="banana-big">🍌</span>
                    <h3>Bir arkadaş seç ve sohbete başla!</h3>
                </div>
                
                <div id="active-chat" class="active-chat hidden">
                    <!-- Sabitlenmiş Mesajlar -->
                    <div id="pinned-messages" class="pinned-messages hidden">
                        <span class="pinned-icon">�</span>v
                        <span id="pinned-text" class="pinned-text">Sabitlenmiş mesaj</span>
                        <button id="close-pinned" class="pinned-close">&times;</button>
                    </div>

                    <div class="chat-header">
                        <div class="chat-user-info">
                            <div class="user-avatar">👤</div>
                            <div class="group-info">
                                <span id="chat-user-name" class="group-name">Arkadaş</span>
                                <div id="group-members-summary" class="group-members-summary hidden">
                                    <span id="members-count">0 üye</span>
                                    <span>•</span>
                                    <span class="online-count" id="online-count">0 çevrimiçi</span>
                                    <button id="members-toggle" class="members-toggle">Üyeleri Göster</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Grup Üyeleri Paneli -->
                        <div id="group-members-panel" class="group-members-panel hidden">
                            <div class="members-panel-header">
                                <span class="members-panel-title">Grup Üyeleri</span>
                                <button id="close-members-panel" class="close-members-panel">&times;</button>
                            </div>
                            <div id="members-list">
                                <!-- Üyeler buraya gelecek -->
                            </div>
                        </div>
                    </div>
                    
                    <div id="messages-container" class="messages-container">
                        <!-- Mesajlar buraya gelecek -->
                    </div>

                    <!-- Yazıyor Göstergesi -->
                    <div id="typing-indicator" class="typing-indicator hidden">
                        <span id="typing-user">Kullanıcı</span> yazıyor
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>

                    <!-- Yanıt Önizleme -->
                    <div id="reply-preview" class="reply-preview hidden">
                        <div class="reply-content">
                            <div class="reply-to">Yanıtlanan: <span id="reply-author"></span></div>
                            <div class="reply-text" id="reply-text"></div>
                        </div>
                        <button id="cancel-reply" class="reply-close">&times;</button>
                    </div>
                    
                    <div class="message-input-area">
                        <div class="input-container">
                            <input type="text" id="message-input" placeholder="Mesajını yaz..." maxlength="500">
                            <div class="input-actions">
                                <input type="file" id="image-upload-input" class="image-upload-input" accept="image/*">
                                <button id="image-btn" class="input-action-btn" title="Resim">📷</button>
                                <button id="emoji-btn" class="input-action-btn" title="Emoji">😀</button>
                                <button id="gif-btn" class="input-action-btn" title="GIF">🎬</button>
                            </div>
                        </div>
                        <button id="send-btn" class="btn primary">Gönder</button>
                        
                        <!-- Emoji/GIF Panel -->
                        <div id="emoji-gif-panel" class="emoji-gif-panel hidden">
                            <div class="panel-tabs">
                                <button id="emoji-tab" class="panel-tab active">😀 Emoji</button>
                                <button id="gif-tab" class="panel-tab">🎬 GIF</button>
                            </div>
                            <div class="panel-content">
                                <!-- Emoji Content -->
                                <div id="emoji-content" class="emoji-content">
                                    <div class="emoji-grid" id="emoji-grid">
                                        <!-- Emojiler buraya gelecek -->
                                    </div>
                                </div>
                                
                                <!-- GIF Content -->
                                <div id="gif-content" class="gif-content hidden">
                                    <div class="gif-search">
                                        <input type="text" id="gif-search-input" placeholder="GIF ara...">
                                    </div>
                                    <div class="gif-grid" id="gif-grid">
                                        <!-- GIF'ler buraya gelecek -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Özel Uyarı Modal -->
    <div id="alert-modal" class="modal hidden">
        <div class="modal-content alert-modal">
            <div class="alert-header">
                <div class="alert-icon" id="alert-icon">ℹ️</div>
                <h3 id="alert-title">Bilgi</h3>
            </div>
            <div class="alert-body">
                <p id="alert-message">Mesaj</p>
            </div>
            <div class="alert-actions">
                <button id="alert-ok-btn" class="btn primary">Tamam</button>
                <button id="alert-cancel-btn" class="btn secondary hidden">İptal</button>
            </div>
        </div>
    </div>

    <!-- Arkadaş Profili Modal -->
    <div id="friend-profile-modal" class="modal hidden">
        <div class="modal-content profile-modal">
            <div class="modal-header">
                <h3 id="friend-profile-title">Arkadaş Profili</h3>
                <button id="close-friend-profile-modal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body profile-body">
                <!-- Avatar Bölümü -->
                <div class="profile-section">
                    <div class="friend-profile-avatar-section">
                        <div class="friend-profile-avatar" id="friend-profile-avatar">👤</div>
                        <div class="friend-profile-info">
                            <h2 id="friend-profile-name">Arkadaş</h2>
                            <p id="friend-profile-username">@username</p>
                            <span id="friend-profile-status" class="friend-profile-status">Çevrimiçi</span>
                        </div>
                    </div>
                </div>

                <!-- Hakkında Bölümü -->
                <div class="profile-section" id="friend-about-section">
                    <h4>Hakkında</h4>
                    <p id="friend-profile-about">Bu kullanıcı henüz hakkında bilgisi eklememiş.</p>
                </div>

                <!-- Eylemler -->
                <div class="profile-section">
                    <div class="friend-profile-actions">
                        <button id="message-friend-btn" class="btn primary">💬 Mesaj Gönder</button>
                        <button id="block-friend-btn" class="btn secondary">🚫 Engelle</button>
                        <button id="remove-friend-btn" class="btn secondary">❌ Arkadaşlıktan Çıkar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grup Oluşturma Modal -->
    <div id="create-group-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Grup Oluştur</h3>
                <button id="close-group-modal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Grup Adı</label>
                    <input type="text" id="group-name" placeholder="Grup adını girin..." maxlength="50">
                </div>
                <div class="form-group">
                    <label>Grup Açıklaması (Opsiyonel)</label>
                    <textarea id="group-description" placeholder="Grup hakkında kısa bir açıklama..." maxlength="200" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Arkadaşları Seç</label>
                    <div id="friends-selection" class="friends-selection">
                        <!-- Arkadaş listesi buraya gelecek -->
                    </div>
                </div>
                <button id="create-group-btn" class="btn primary">Grup Oluştur</button>
            </div>
        </div>
    </div>

    <!-- Profil Düzenleme Modal -->
    <div id="profile-modal" class="modal hidden">
        <div class="modal-content profile-modal">
            <div class="modal-header">
                <h3>Profilimi Düzenle</h3>
                <button id="close-profile-modal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body profile-body">
                <!-- Banner Bölümü -->
                <div class="profile-section">
                    <h4>Profil Banner'ı</h4>
                    <div class="profile-banner" id="profile-banner">
                        <div class="banner-overlay">
                            <div class="banner-actions">
                                <input type="file" id="banner-input" accept="image/*" style="display: none;">
                                <button id="upload-banner-btn" class="banner-btn">Banner Yükle</button>
                                <button id="remove-banner-btn" class="banner-btn">Kaldır</button>
                            </div>
                        </div>
                    </div>
                    <p class="help-text">JPG, PNG. Maksimum 3MB. Önerilen boyut: 600x200px</p>
                </div>

                <!-- Avatar Bölümü -->
                <div class="profile-section">
                    <h4>Avatar</h4>
                    <div class="avatar-section">
                        <div class="current-avatar" id="profile-avatar">👤</div>
                        <div class="avatar-actions">
                            <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                            <button id="upload-avatar-btn" class="btn primary small">Avatar Yükle</button>
                            <button id="remove-avatar-btn" class="btn secondary small">Kaldır</button>
                        </div>
                    </div>
                    <p class="help-text">JPG, PNG veya GIF. Maksimum 2MB.</p>
                </div>

                <!-- Kullanıcı Bilgileri -->
                <div class="profile-section">
                    <h4>Kullanıcı Bilgileri</h4>
                    <div class="form-group">
                        <label>Görünen Ad</label>
                        <input type="text" id="profile-display-name" placeholder="Görünen adın" maxlength="32">
                    </div>
                    <div class="form-group">
                        <label>Kullanıcı Adı</label>
                        <div class="username-input">
                            <span class="username-prefix">@</span>
                            <input type="text" id="profile-username" placeholder="kullaniciadi" maxlength="20">
                        </div>
                        <p class="help-text">Sadece harf, rakam ve alt çizgi kullanabilirsiniz. Arkadaşların seni bu kullanıcı adı ile bulabilir.</p>
                    </div>
                    <div class="form-group">
                        <label>E-posta</label>
                        <input type="email" id="profile-email" disabled>
                    </div>
                </div>

                <!-- Hakkında Bölümü -->
                <div class="profile-section">
                    <h4>Hakkında</h4>
                    <div class="form-group">
                        <textarea id="profile-about" placeholder="Kendin hakkında bir şeyler yaz..." maxlength="190" rows="3"></textarea>
                        <div class="char-count">
                            <span id="about-char-count">0</span>/190
                        </div>
                    </div>
                </div>

                <!-- Durum Bölümü -->
                <div class="profile-section">
                    <h4>Durum</h4>
                    <div class="status-options">
                        <div class="status-option" data-status="online">
                            <div class="status-indicator online"></div>
                            <span>Çevrimiçi</span>
                        </div>
                        <div class="status-option" data-status="away">
                            <div class="status-indicator away"></div>
                            <span>Uzakta</span>
                        </div>
                        <div class="status-option" data-status="busy">
                            <div class="status-indicator busy"></div>
                            <span>Meşgul</span>
                        </div>
                        <div class="status-option" data-status="invisible">
                            <div class="status-indicator invisible"></div>
                            <span>Görünmez</span>
                        </div>
                    </div>
                </div>

                <!-- Engellenen Kullanıcılar -->
                <div class="profile-section">
                    <h4>Engellenen Kullanıcılar</h4>
                    <div id="blocked-users-list" class="blocked-users-list">
                        <!-- Engellenen kullanıcılar buraya gelecek -->
                    </div>
                </div>

                <!-- Nitro Özellikleri -->
                <div class="profile-section">
                    <div class="nitro-features">
                        <div class="nitro-title">
                            <span class="nitro-icon">⭐</span>
                            BananaChat Premium
                            <span class="nitro-badge">PREMIUM</span>
                        </div>
                        <div class="nitro-feature">
                            <span class="nitro-icon">🎨</span>
                            <span>Özel profil banner'ı</span>
                        </div>
                        <div class="nitro-feature">
                            <span class="nitro-icon">😀</span>
                            <span>Büyük emoji kullanımı</span>
                        </div>
                        <div class="nitro-feature">
                            <span class="nitro-icon">📁</span>
                            <span>10MB dosya yükleme</span>
                        </div>
                        <div class="nitro-feature">
                            <span class="nitro-icon">🎬</span>
                            <span>HD GIF paylaşımı</span>
                        </div>
                    </div>
                </div>

                <!-- Kaydet Butonu -->
                <div class="profile-actions">
                    <button id="save-profile-btn" class="btn primary">Değişiklikleri Kaydet</button>
                    <button id="cancel-profile-btn" class="btn secondary">İptal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Arkadaş Ekleme Modal -->
    <div id="add-friend-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Arkadaş Ekle</h3>
                <button id="close-modal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="friend-username" placeholder="Kullanıcı adı (örn: @kullaniciadi)">
                <button id="send-friend-request" class="btn primary">Arkadaşlık İsteği Gönder</button>
            </div>
        </div>
    </div>

    <!-- Bildirim Popup -->
    <div id="notification-popup" class="notification-popup hidden">
        <div class="notification-header">
            <div id="notification-avatar" class="notification-avatar">👤</div>
            <div id="notification-title" class="notification-title">Yeni Mesaj</div>
        </div>
        <div id="notification-message" class="notification-message">Mesaj içeriği</div>
    </div>

    <!-- Resim Önizleme Modal -->
    <div id="image-preview-modal" class="image-preview-modal hidden">
        <div class="image-preview-content">
            <button id="image-preview-close" class="image-preview-close">&times;</button>
            <img id="image-preview-img" src="" alt="Resim Önizleme">
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase yapılandırması
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, getDocs, updateDoc, arrayUnion, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase yapılandırma objesi
        const firebaseConfig = {
          apiKey: "AIzaSyC9JVweNrrypKbSTn9mbVvAUqEyYgjFVxs",
          authDomain: "bananachat-75830.firebaseapp.com",
          projectId: "bananachat-75830",
          storageBucket: "bananachat-75830.firebasestorage.app",
          messagingSenderId: "610695252418",
          appId: "1:610695252418:web:218ab8e566b901cb1bee5b",
          measurementId: "G-EPCFQ6C00S"
        };

        // Firebase'i başlat
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        console.log('Firebase başlatıldı!');

        // Global fonksiyonlar (HTML onclick için)
        window.openProfile = function() {
            console.log('window.openProfile çağrıldı');
            openProfileModal();
        };

        // Resim önizleme göster (global fonksiyon)
        window.showImagePreview = function(imageSrc) {
            imagePreviewImg.src = imageSrc;
            imagePreviewModal.classList.remove('hidden');
        };

        // Discord tarzı mesaj silme fonksiyonu
        window.deleteMessage = async function(messageId, isGroup) {
            const confirmed = await showConfirm(
                'Bu mesajı silmek istediğinizden emin misiniz?',
                'Mesajı Sil'
            );
            
            if (!confirmed) return;
            
            try {
                // Mesaj elementini bul ve siliniyor olarak işaretle
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.classList.add('deleting');
                }
                
                let docRef;
                if (isGroup) {
                    // Grup mesajı sil
                    docRef = doc(db, 'groups', activeChatUser.id, 'messages', messageId);
                } else {
                    // Bireysel mesaj sil
                    const chatId = currentUser.uid < activeChatUser.id ? 
                        `${currentUser.uid}_${activeChatUser.id}` : 
                        `${activeChatUser.id}_${currentUser.uid}`;
                    docRef = doc(db, 'chats', chatId, 'messages', messageId);
                }
                
                // Mesajı "silindi" olarak işaretle
                await updateDoc(docRef, {
                    deleted: true,
                    deletedAt: serverTimestamp(),
                    deletedBy: currentUser.uid
                });
                
                showSuccess('Mesaj silindi!');
                
            } catch (error) {
                console.error('Mesaj silme hatası:', error);
                showError('Mesaj silinirken bir hata oluştu!');
                
                // Hata durumunda deleting class'ını kaldır
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.classList.remove('deleting');
                }
            }
        };

        // Özel Alert Fonksiyonları
        function showAlert(message, type = 'info', title = null, showCancel = false) {
            return new Promise((resolve) => {
                alertResolve = resolve;
                
                // Diğer açık modal'ları geçici olarak gizle
                const openModals = document.querySelectorAll('.modal:not(#alert-modal):not(.hidden)');
                openModals.forEach(modal => {
                    modal.style.zIndex = '999'; // Alert'in altına gönder
                });
                
                // İkon ve başlık ayarla
                const icons = {
                    'info': { icon: 'ℹ️', title: 'Bilgi', class: 'info' },
                    'success': { icon: '✅', title: 'Başarılı', class: 'success' },
                    'warning': { icon: '⚠️', title: 'Uyarı', class: 'warning' },
                    'error': { icon: '❌', title: 'Hata', class: 'error' }
                };
                
                const config = icons[type] || icons.info;
                
                alertIcon.textContent = config.icon;
                alertIcon.className = `alert-icon ${config.class}`;
                alertTitle.textContent = title || config.title;
                alertMessage.textContent = message;
                
                // Butonları ayarla
                if (showCancel) {
                    alertCancelBtn.classList.remove('hidden');
                    alertOkBtn.textContent = 'Evet';
                } else {
                    alertCancelBtn.classList.add('hidden');
                    alertOkBtn.textContent = 'Tamam';
                }
                
                // Alert modal'ı göster
                alertModal.style.zIndex = '10000';
                alertModal.classList.remove('hidden');
                
                // Alert kapandığında diğer modal'ların z-index'ini geri yükle
                const restoreModals = () => {
                    openModals.forEach(modal => {
                        modal.style.zIndex = '1000';
                    });
                };
                
                // Promise resolve edildiğinde modal'ları geri yükle
                const originalResolve = alertResolve;
                alertResolve = (value) => {
                    restoreModals();
                    originalResolve(value);
                };
            });
        }

        // Kısa yollar
        function showInfo(message, title = null) {
            return showAlert(message, 'info', title);
        }

        function showSuccess(message, title = null) {
            return showAlert(message, 'success', title);
        }

        function showWarning(message, title = null) {
            return showAlert(message, 'warning', title);
        }

        function showError(message, title = null) {
            return showAlert(message, 'error', title);
        }

        function showConfirm(message, title = 'Onay') {
            return showAlert(message, 'warning', title, true);
        }

        // Profil modalını aç
        function openProfileModal() {
            console.log('openProfileModal çağrıldı');
            console.log('currentUserData:', currentUserData);
            
            if (!currentUserData) {
                console.log('currentUserData yok, fallback oluşturuluyor...');
                // Fallback veri oluştur
                currentUserData = {
                    name: currentUser?.displayName || 'Kullanıcı',
                    email: currentUser?.email || '',
                    displayName: currentUser?.displayName || 'Kullanıcı',
                    username: currentUser?.email?.split('@')[0]?.toLowerCase()?.replace(/[^a-z0-9_]/g, '') || 'kullanici',
                    about: '',
                    status: 'online',
                    avatar: null,
                    banner: null,
                    friends: []
                };
            }
            
            try {
                // Form verilerini doldur
                profileDisplayName.value = currentUserData.displayName || currentUserData.name || '';
                profileUsername.value = currentUserData.username || '';
                profileEmail.value = currentUserData.email || '';
                profileAbout.value = currentUserData.about || '';
                
                console.log('Form verileri dolduruldu');
                
                // Avatar güncelle
                if (currentUserData.avatar) {
                    profileAvatar.style.backgroundImage = `url(${currentUserData.avatar})`;
                    profileAvatar.textContent = '';
                } else {
                    profileAvatar.style.backgroundImage = '';
                    profileAvatar.textContent = '👤';
                }

                // Banner güncelle
                if (currentUserData.banner) {
                    profileBanner.style.backgroundImage = `url(${currentUserData.banner})`;
                } else {
                    profileBanner.style.backgroundImage = '';
                }
                
                console.log('Avatar ve banner güncellendi');
                
                // Durum seç
                selectStatus(currentUserData.status || 'online');
                
                // Karakter sayısını güncelle
                updateCharCount();
                
                // Engellenen kullanıcıları yükle
                loadBlockedUsers();
                
                console.log('Modal açılıyor...');
                profileModal.classList.remove('hidden');
                console.log('Modal açıldı!');
                
            } catch (error) {
                console.error('Profil modal açma hatası:', error);
                showError('Profil açılırken bir hata oluştu!');
            }
        }

        // DOM elementleri
        const authContainer = document.getElementById('auth-container');
        const chatContainer = document.getElementById('chat-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');

        // Auth form elementleri
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const registerName = document.getElementById('register-name');
        const registerEmail = document.getElementById('register-email');
        const registerPassword = document.getElementById('register-password');
        const registerBtn = document.getElementById('register-btn');

        // Chat elementleri
        const currentUserName = document.getElementById('current-user-name');
        const currentUserAvatar = document.getElementById('current-user-avatar');
        const currentUserStatus = document.getElementById('current-user-status');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const friendsList = document.getElementById('friends-list');
        const addFriendBtn = document.getElementById('add-friend-btn');
        const createGroupBtnHeader = document.getElementById('create-group-btn-header');
        const addFriendModal = document.getElementById('add-friend-modal');
        const closeModal = document.getElementById('close-modal');
        const friendUsername = document.getElementById('friend-username');
        const sendFriendRequest = document.getElementById('send-friend-request');
        const noChat = document.getElementById('no-chat');
        const activeChat = document.getElementById('active-chat');
        const chatUserName = document.getElementById('chat-user-name');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');

        // Grup üyeleri elementleri
        const groupMembersSummary = document.getElementById('group-members-summary');
        const membersCount = document.getElementById('members-count');
        const onlineCount = document.getElementById('online-count');
        const membersToggle = document.getElementById('members-toggle');
        const groupMembersPanel = document.getElementById('group-members-panel');
        const closeMembersPanel = document.getElementById('close-members-panel');
        const membersList = document.getElementById('members-list');

        // Emoji ve GIF elementleri
        const emojiBtn = document.getElementById('emoji-btn');
        const gifBtn = document.getElementById('gif-btn');
        const imageBtn = document.getElementById('image-btn');
        const imageUploadInput = document.getElementById('image-upload-input');
        const emojiGifPanel = document.getElementById('emoji-gif-panel');
        const emojiTab = document.getElementById('emoji-tab');
        const gifTab = document.getElementById('gif-tab');
        const emojiContent = document.getElementById('emoji-content');
        const gifContent = document.getElementById('gif-content');
        const emojiGrid = document.getElementById('emoji-grid');
        const gifGrid = document.getElementById('gif-grid');
        const gifSearchInput = document.getElementById('gif-search-input');

        // Resim önizleme elementleri
        const imagePreviewModal = document.getElementById('image-preview-modal');
        const imagePreviewImg = document.getElementById('image-preview-img');
        const imagePreviewClose = document.getElementById('image-preview-close');

        // Arkadaş profili elementleri
        const friendProfileModal = document.getElementById('friend-profile-modal');
        const closeFriendProfileModal = document.getElementById('close-friend-profile-modal');
        const friendProfileAvatar = document.getElementById('friend-profile-avatar');
        const friendProfileName = document.getElementById('friend-profile-name');
        const friendProfileUsername = document.getElementById('friend-profile-username');
        const friendProfileStatus = document.getElementById('friend-profile-status');
        const friendProfileAbout = document.getElementById('friend-profile-about');
        const messageFriendBtn = document.getElementById('message-friend-btn');
        const blockFriendBtn = document.getElementById('block-friend-btn');
        const removeFriendBtn = document.getElementById('remove-friend-btn');

        // Grup oluşturma modal elementleri
        const createGroupModal = document.getElementById('create-group-modal');
        const closeGroupModal = document.getElementById('close-group-modal');
        const groupName = document.getElementById('group-name');
        const groupDescription = document.getElementById('group-description');
        const friendsSelection = document.getElementById('friends-selection');
        const createGroupBtn = document.getElementById('create-group-btn');

        // Profil modal elementleri
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModal = document.getElementById('close-profile-modal');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileBanner = document.getElementById('profile-banner');
        const bannerInput = document.getElementById('banner-input');
        const uploadBannerBtn = document.getElementById('upload-banner-btn');
        const removeBannerBtn = document.getElementById('remove-banner-btn');
        const avatarInput = document.getElementById('avatar-input');
        const uploadAvatarBtn = document.getElementById('upload-avatar-btn');
        const removeAvatarBtn = document.getElementById('remove-avatar-btn');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileUsername = document.getElementById('profile-username');
        const profileEmail = document.getElementById('profile-email');
        const profileAbout = document.getElementById('profile-about');
        const aboutCharCount = document.getElementById('about-char-count');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelProfileBtn = document.getElementById('cancel-profile-btn');

        // Yeni özellik elementleri
        const showRequestsBtn = document.getElementById('show-requests-btn');
        const closeRequestsBtn = document.getElementById('close-requests-btn');
        const friendRequestsSection = document.getElementById('friend-requests-section');
        const friendRequestsList = document.getElementById('friend-requests-list');
        const typingIndicator = document.getElementById('typing-indicator');
        const typingUser = document.getElementById('typing-user');
        const replyPreview = document.getElementById('reply-preview');
        const replyAuthor = document.getElementById('reply-author');
        const replyText = document.getElementById('reply-text');
        const cancelReply = document.getElementById('cancel-reply');
        // Pinned messages variables - REMOVED
        // const pinnedMessages = document.getElementById('pinned-messages');
        // const pinnedText = document.getElementById('pinned-text');
        // const closePinned = document.getElementById('close-pinned');
        const blockedUsersList = document.getElementById('blocked-users-list');
        const notificationPopup = document.getElementById('notification-popup');
        const notificationAvatar = document.getElementById('notification-avatar');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');

        // Element kontrolü
        console.log('Profil modal elementleri:', {
            profileModal: !!profileModal,
            closeProfileModal: !!closeProfileModal,
            profileAvatar: !!profileAvatar,
            editProfileBtn: !!editProfileBtn
        });

        // Alert modal elementleri
        const alertModal = document.getElementById('alert-modal');
        const alertIcon = document.getElementById('alert-icon');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertOkBtn = document.getElementById('alert-ok-btn');
        const alertCancelBtn = document.getElementById('alert-cancel-btn');

        // Global değişkenler
        let currentUser = null;
        let activeChatUser = null;
        let messagesListener = null;
        let currentUserData = null;
        let alertResolve = null;
        let unreadMessages = {}; // Okunmamış mesajları takip et
        let currentFriendProfile = null;
        let userGroups = []; // Kullanıcının grupları
        let replyingTo = null; // Yanıtlanan mesaj
        let typingTimeout = null; // Yazıyor göstergesi timeout
        // let pinnedMessage = null; // Sabitlenmiş mesaj - KALDIRILDI
        let friendRequests = []; // Arkadaş istekleri
        let blockedUsers = []; // Engellenen kullanıcılar

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM yüklendi, event listener\'lar ekleniyor...');
            
            // Element kontrolü
            console.log('DOM elementleri kontrol ediliyor...');
            console.log('editProfileBtn:', document.getElementById('edit-profile-btn'));
            console.log('profileModal:', document.getElementById('profile-modal'));
            
            // Auth state değişikliklerini dinle
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    showChatInterface();
                    loadUserData();
                } else {
                    currentUser = null;
                    showAuthInterface();
                }
            });

            // Event listener'ları ekle
            setupEventListeners();
        });

        // Event listener'ları ayarla
        function setupEventListeners() {
            console.log('Event listener\'lar ayarlanıyor...');
            
            // Auth form geçişleri
            showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            });

            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });

            // Auth butonları
            loginBtn.addEventListener('click', handleLogin);
            registerBtn.addEventListener('click', handleRegister);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Profil düzenleme butonu
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Profil butonu tıklandı!');
                    console.log('profileModal element:', profileModal);
                    openProfileModal();
                });
                console.log('Profil butonu event listener eklendi');
            } else {
                console.error('editProfileBtn bulunamadı!');
            }

            // Enter tuşu ile form gönderimi
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            registerPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRegister();
            });

            // Profil düzenleme
            closeProfileModal.addEventListener('click', closeProfile);
            cancelProfileBtn.addEventListener('click', closeProfile);
            uploadAvatarBtn.addEventListener('click', () => avatarInput.click());
            avatarInput.addEventListener('change', handleAvatarUpload);
            removeAvatarBtn.addEventListener('click', removeAvatar);
            saveProfileBtn.addEventListener('click', saveProfile);
            
            // Profil form event'leri
            profileAbout.addEventListener('input', updateCharCount);
            profileUsername.addEventListener('input', validateUsername);
            
            // Durum seçimi
            document.querySelectorAll('.status-option').forEach(option => {
                option.addEventListener('click', () => selectStatus(option.dataset.status));
            });

            // Profil modal dışına tıklayınca kapat
            profileModal.addEventListener('click', (e) => {
                if (e.target === profileModal) {
                    closeProfile();
                }
            });
            addFriendBtn.addEventListener('click', () => {
                addFriendModal.classList.remove('hidden');
            });
            closeModal.addEventListener('click', () => {
                addFriendModal.classList.add('hidden');
                friendUsername.value = '';
            });
            sendFriendRequest.addEventListener('click', handleAddFriend);

            // Grup oluşturma
            createGroupBtnHeader.addEventListener('click', () => {
                openCreateGroupModal();
            });
            closeGroupModal.addEventListener('click', () => {
                createGroupModal.classList.add('hidden');
                groupName.value = '';
                groupDescription.value = '';
            });
            createGroupBtn.addEventListener('click', handleCreateGroup);

            // Grup üyeleri paneli
            membersToggle.addEventListener('click', () => {
                groupMembersPanel.classList.toggle('hidden');
            });
            closeMembersPanel.addEventListener('click', () => {
                groupMembersPanel.classList.add('hidden');
            });

            // Panel dışına tıklayınca kapat
            document.addEventListener('click', (e) => {
                if (!groupMembersPanel.contains(e.target) && !membersToggle.contains(e.target)) {
                    groupMembersPanel.classList.add('hidden');
                }
                
                // Emoji/GIF panelini kapat
                if (!emojiGifPanel.contains(e.target) && !emojiBtn.contains(e.target) && !gifBtn.contains(e.target)) {
                    emojiGifPanel.classList.add('hidden');
                }
                
                // Resim önizleme modal'ını kapat
                if (e.target === imagePreviewModal) {
                    imagePreviewModal.classList.add('hidden');
                }
            });

            // Emoji, GIF ve resim butonları
            emojiBtn.addEventListener('click', () => {
                toggleEmojiGifPanel('emoji');
            });
            
            gifBtn.addEventListener('click', () => {
                toggleEmojiGifPanel('gif');
            });

            imageBtn.addEventListener('click', () => {
                imageUploadInput.click();
            });

            imageUploadInput.addEventListener('change', handleImageUpload);

            // Resim önizleme modal
            imagePreviewClose.addEventListener('click', () => {
                imagePreviewModal.classList.add('hidden');
            });

            // Panel tab'ları
            emojiTab.addEventListener('click', () => {
                switchTab('emoji');
            });
            
            gifTab.addEventListener('click', () => {
                switchTab('gif');
            });

            // Yeni özellik event listener'ları
            showRequestsBtn.addEventListener('click', () => {
                friendRequestsSection.classList.toggle('hidden');
            });
            
            closeRequestsBtn.addEventListener('click', () => {
                friendRequestsSection.classList.add('hidden');
            });

            cancelReply.addEventListener('click', () => {
                cancelReplyMessage();
            });

            // Pinned messages event listener - REMOVED
            // closePinned.addEventListener('click', () => {
            //     pinnedMessages.classList.add('hidden');
            // });

            // Banner upload
            uploadBannerBtn.addEventListener('click', () => bannerInput.click());
            bannerInput.addEventListener('change', handleBannerUpload);
            removeBannerBtn.addEventListener('click', removeBanner);

            // Yazıyor göstergesi
            messageInput.addEventListener('input', handleTyping);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Arkadaş profili
            closeFriendProfileModal.addEventListener('click', () => {
                friendProfileModal.classList.add('hidden');
            });
            messageFriendBtn.addEventListener('click', () => {
                if (currentFriendProfile) {
                    friendProfileModal.classList.add('hidden');
                    openChat(currentFriendProfile.id, currentFriendProfile.name);
                }
            });
            blockFriendBtn.addEventListener('click', () => {
                if (currentFriendProfile) {
                    // Engelleme durumunu kontrol et
                    const isBlocked = currentUserData.blockedUsers && currentUserData.blockedUsers.includes(currentFriendProfile.id);
                    
                    if (isBlocked) {
                        // Engeli kaldır
                        unblockUser(currentFriendProfile.id, currentFriendProfile.name);
                    } else {
                        // Engelle
                        blockUser(currentFriendProfile.id, currentFriendProfile.name);
                    }
                }
            });
            removeFriendBtn.addEventListener('click', handleRemoveFriend);
            closeModal.addEventListener('click', () => {
                addFriendModal.classList.add('hidden');
                friendUsername.value = '';
            });
            sendFriendRequest.addEventListener('click', handleAddFriend);

            // Mesaj gönderme
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // GIF arama
            const debouncedGifSearch = debounce(searchGifs, 500);
            gifSearchInput.addEventListener('input', debouncedGifSearch);

            // Panel dışına tıklayınca kapat
            document.addEventListener('click', (e) => {
                if (!emojiGifPanel.contains(e.target) && !emojiBtn.contains(e.target) && !gifBtn.contains(e.target)) {
                    emojiGifPanel.classList.add('hidden');
                }
            });

            // Modal dışına tıklayınca kapat
            addFriendModal.addEventListener('click', (e) => {
                if (e.target === addFriendModal) {
                    addFriendModal.classList.add('hidden');
                    friendUsername.value = '';
                }
            });

            // Grup modal dışına tıklayınca kapat
            createGroupModal.addEventListener('click', (e) => {
                if (e.target === createGroupModal) {
                    createGroupModal.classList.add('hidden');
                    groupName.value = '';
                    groupDescription.value = '';
                }
            });

            // Profil modal dışına tıklayınca kapat
            friendProfileModal.addEventListener('click', (e) => {
                if (e.target === friendProfileModal) {
                    friendProfileModal.classList.add('hidden');
                }
            });

            // Resim önizleme modal dışına tıklayınca kapat
            imagePreviewModal.addEventListener('click', (e) => {
                if (e.target === imagePreviewModal) {
                    imagePreviewModal.classList.add('hidden');
                }
            });

            // Bildirim popup'ına tıklayınca kapat
            notificationPopup.addEventListener('click', () => {
                notificationPopup.classList.add('hidden');
            });

            // Alert modal event'leri
            alertOkBtn.addEventListener('click', () => {
                alertModal.classList.add('hidden');
                // Z-index'i sıfırla
                alertModal.style.zIndex = '10000';
                if (alertResolve) {
                    alertResolve(true);
                    alertResolve = null;
                }
            });

            alertCancelBtn.addEventListener('click', () => {
                alertModal.classList.add('hidden');
                // Z-index'i sıfırla
                alertModal.style.zIndex = '10000';
                if (alertResolve) {
                    alertResolve(false);
                    alertResolve = null;
                }
            });

            // ESC tuşu ile modal'ları kapat
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!alertModal.classList.contains('hidden')) {
                        alertModal.classList.add('hidden');
                        // Z-index'i sıfırla
                        alertModal.style.zIndex = '10000';
                        if (alertResolve) {
                            alertResolve(false);
                            alertResolve = null;
                        }
                    }
                }
            });

            console.log('Event listener\'lar başarıyla eklendi!');
        }

        // Giriş işlemi
        async function handleLogin() {
            console.log('Giriş işlemi başlatıldı...');
            const email = loginEmail.value.trim();
            const password = loginPassword.value;

            if (!email || !password) {
                showWarning('Lütfen tüm alanları doldurun!');
                return;
            }

            try {
                loginBtn.textContent = 'Giriş yapılıyor...';
                loginBtn.disabled = true;
                
                await signInWithEmailAndPassword(auth, email, password);
                
                // Form temizle
                loginEmail.value = '';
                loginPassword.value = '';
                
            } catch (error) {
                console.error('Giriş hatası:', error);
                let errorMessage = 'Giriş yapılırken bir hata oluştu!';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Bu e-posta adresi ile kayıtlı kullanıcı bulunamadı!';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Hatalı şifre!';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Geçersiz e-posta adresi!';
                }
                
                showError(errorMessage);
            } finally {
                loginBtn.textContent = 'Giriş Yap';
                loginBtn.disabled = false;
            }
        }

        // Kayıt işlemi
        async function handleRegister() {
            console.log('Kayıt işlemi başlatıldı...');
            const name = registerName.value.trim();
            const email = registerEmail.value.trim();
            const password = registerPassword.value;

            if (!name || !email || !password) {
                showWarning('Lütfen tüm alanları doldurun!');
                return;
            }

            if (password.length < 6) {
                showWarning('Şifre en az 6 karakter olmalıdır!');
                return;
            }

            try {
                registerBtn.textContent = 'Kayıt olunuyor...';
                registerBtn.disabled = true;
                
                // Kullanıcı oluştur
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Profil güncelle
                await updateProfile(user, {
                    displayName: name
                });
                
                // Firestore'da kullanıcı belgesi oluştur
                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    displayName: name,
                    username: email.split('@')[0].toLowerCase().replace(/[^a-z0-9_]/g, ''),
                    about: '',
                    status: 'online',
                    avatar: null,
                    createdAt: serverTimestamp(),
                    friends: []
                });
                
                // Form temizle
                registerName.value = '';
                registerEmail.value = '';
                registerPassword.value = '';
                
                showSuccess('Kayıt başarılı! Hoş geldin!', 'Hoş Geldin!');
                
            } catch (error) {
                console.error('Kayıt hatası:', error);
                let errorMessage = 'Kayıt olurken bir hata oluştu!';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Bu e-posta adresi zaten kullanımda!';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Geçersiz e-posta adresi!';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Şifre çok zayıf!';
                }
                
                showError(errorMessage);
            } finally {
                registerBtn.textContent = 'Kayıt Ol';
                registerBtn.disabled = false;
            }
        }

        // Çıkış işlemi
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Çıkış hatası:', error);
                showError('Çıkış yapılırken bir hata oluştu!');
            }
        }

        // Auth arayüzünü göster
        function showAuthInterface() {
            authContainer.classList.remove('hidden');
            chatContainer.classList.add('hidden');
        }

        // Chat arayüzünü göster
        function showChatInterface() {
            authContainer.classList.add('hidden');
            chatContainer.classList.remove('hidden');
        }

        // Kullanıcı verilerini yükle
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                console.log('Kullanıcı verileri yükleniyor...', currentUser.uid);
                
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    console.log('Kullanıcı verileri yüklendi:', currentUserData);
                    
                    // UI güncelle
                    currentUserName.textContent = currentUserData.displayName || currentUserData.name || 'Kullanıcı';
                    currentUserStatus.textContent = getStatusText(currentUserData.status || 'online');
                    
                    // Avatar güncelle
                    if (currentUserData.avatar) {
                        currentUserAvatar.style.backgroundImage = `url(${currentUserData.avatar})`;
                        currentUserAvatar.textContent = '';
                    } else {
                        currentUserAvatar.style.backgroundImage = '';
                        currentUserAvatar.textContent = '👤';
                    }
                } else {
                    console.log('Kullanıcı belgesi yok, oluşturuluyor...');
                    // Kullanıcı belgesi yoksa oluştur
                    currentUserData = {
                        name: currentUser.displayName || 'Kullanıcı',
                        email: currentUser.email,
                        displayName: currentUser.displayName || 'Kullanıcı',
                        username: currentUser.email.split('@')[0].toLowerCase().replace(/[^a-z0-9_]/g, ''),
                        about: '',
                        status: 'online',
                        avatar: null,
                        friends: []
                    };
                    
                    await setDoc(doc(db, 'users', currentUser.uid), {
                        ...currentUserData,
                        createdAt: serverTimestamp()
                    });
                    
                    console.log('Kullanıcı belgesi oluşturuldu:', currentUserData);
                    
                    currentUserName.textContent = currentUserData.displayName;
                    currentUserStatus.textContent = 'Çevrimiçi';
                }
                
                // Arkadaşları yükle
                await loadFriends();
                
                // Grupları yükle
                await loadGroups();

                // Arkadaş isteklerini yükle
                await loadFriendRequests();
                
                // Bildirim izni iste
                requestNotificationPermission();
                
            } catch (error) {
                console.error('Kullanıcı verileri yüklenirken hata:', error);
                
                // Hata durumunda temel verileri oluştur
                currentUserData = {
                    name: currentUser.displayName || 'Kullanıcı',
                    email: currentUser.email,
                    displayName: currentUser.displayName || 'Kullanıcı',
                    username: currentUser.email.split('@')[0].toLowerCase().replace(/[^a-z0-9_]/g, ''),
                    about: '',
                    status: 'online',
                    avatar: null,
                    friends: []
                };
                
                currentUserName.textContent = currentUserData.displayName;
                currentUserStatus.textContent = 'Çevrimiçi';
                
                console.log('Fallback kullanıcı verileri oluşturuldu:', currentUserData);
            }
        }

        // Durum metni al
        function getStatusText(status) {
            const statusTexts = {
                'online': 'Çevrimiçi',
                'away': 'Uzakta',
                'busy': 'Meşgul',
                'invisible': 'Görünmez'
            };
            return statusTexts[status] || 'Çevrimiçi';
        }

        // Profil modalını kapat
        function closeProfile() {
            profileModal.classList.add('hidden');
        }

        // Avatar yükleme (Base64 ile - Firebase Storage olmadan)
        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Dosya boyutu kontrolü (2MB)
            if (file.size > 2 * 1024 * 1024) {
                showWarning('Dosya boyutu 2MB\'dan küçük olmalıdır!');
                return;
            }

            // Dosya tipi kontrolü
            if (!file.type.startsWith('image/')) {
                showWarning('Sadece resim dosyaları yükleyebilirsiniz!');
                return;
            }

            try {
                uploadAvatarBtn.textContent = 'Yükleniyor...';
                uploadAvatarBtn.disabled = true;

                // Base64'e çevir
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    
                    // Profil avatarını güncelle
                    profileAvatar.style.backgroundImage = `url(${base64Image})`;
                    profileAvatar.textContent = '';

                    // Geçici olarak currentUserData'yı güncelle
                    currentUserData.avatar = base64Image;
                    
                    uploadAvatarBtn.textContent = 'Avatar Yükle';
                    uploadAvatarBtn.disabled = false;
                    
                    showSuccess('Avatar başarıyla yüklendi!');
                };
                
                reader.onerror = function() {
                    showError('Dosya okuma hatası!');
                    uploadAvatarBtn.textContent = 'Avatar Yükle';
                    uploadAvatarBtn.disabled = false;
                };
                
                reader.readAsDataURL(file);

            } catch (error) {
                console.error('Avatar yükleme hatası:', error);
                showError('Avatar yüklenirken bir hata oluştu!');
                uploadAvatarBtn.textContent = 'Avatar Yükle';
                uploadAvatarBtn.disabled = false;
            }
        }

        // Avatar kaldır (Base64 versiyonu)
        async function removeAvatar() {
            try {
                // UI'dan kaldır
                profileAvatar.style.backgroundImage = '';
                profileAvatar.textContent = '👤';

                // Geçici olarak currentUserData'yı güncelle
                currentUserData.avatar = null;
                
                showSuccess('Avatar kaldırıldı!');

            } catch (error) {
                console.error('Avatar kaldırma hatası:', error);
                // Hata olsa bile UI'dan kaldır
                profileAvatar.style.backgroundImage = '';
                profileAvatar.textContent = '👤';
                currentUserData.avatar = null;
            }
        }

        // Kullanıcı adı doğrulama
        function validateUsername() {
            const username = profileUsername.value;
            const validUsername = username.toLowerCase().replace(/[^a-z0-9_]/g, '');
            if (username !== validUsername) {
                profileUsername.value = validUsername;
            }
        }

        // Karakter sayısını güncelle
        function updateCharCount() {
            const count = profileAbout.value.length;
            aboutCharCount.textContent = count;
            
            if (count > 190) {
                aboutCharCount.style.color = '#f56565';
            } else {
                aboutCharCount.style.color = '#a0aec0';
            }
        }

        // Durum seç
        function selectStatus(status) {
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('active');
            });
            
            const selectedOption = document.querySelector(`[data-status="${status}"]`);
            if (selectedOption) {
                selectedOption.classList.add('active');
            }
        }

        // Profil kaydet
        async function saveProfile() {
            const displayName = profileDisplayName.value.trim();
            const username = profileUsername.value.trim();
            const about = profileAbout.value.trim();
            const selectedStatus = document.querySelector('.status-option.active')?.dataset.status || 'online';

            if (!displayName) {
                showWarning('Görünen ad boş olamaz!');
                return;
            }

            if (!username) {
                showWarning('Kullanıcı adı boş olamaz!');
                return;
            }

            if (username.length < 3) {
                showWarning('Kullanıcı adı en az 3 karakter olmalıdır!');
                return;
            }

            try {
                saveProfileBtn.textContent = 'Kaydediliyor...';
                saveProfileBtn.disabled = true;

                // Kullanıcı adı benzersizlik kontrolü
                if (username !== currentUserData.username) {
                    const usernameQuery = query(collection(db, 'users'), where('username', '==', username));
                    const usernameSnapshot = await getDocs(usernameQuery);
                    
                    if (!usernameSnapshot.empty) {
                        showWarning('Bu kullanıcı adı zaten kullanımda!');
                        return;
                    }
                }

                // Profil güncelle
                const updatedData = {
                    displayName: displayName,
                    username: username,
                    about: about,
                    status: selectedStatus,
                    avatar: currentUserData.avatar,
                    banner: currentUserData.banner
                };

                await updateDoc(doc(db, 'users', currentUser.uid), updatedData);

                // Firebase Auth profil güncelle
                await updateProfile(currentUser, {
                    displayName: displayName
                });

                // Local data güncelle
                currentUserData = { ...currentUserData, ...updatedData };

                // UI güncelle
                currentUserName.textContent = displayName;
                currentUserStatus.textContent = getStatusText(selectedStatus);
                
                if (currentUserData.avatar) {
                    currentUserAvatar.style.backgroundImage = `url(${currentUserData.avatar})`;
                    currentUserAvatar.textContent = '';
                } else {
                    currentUserAvatar.style.backgroundImage = '';
                    currentUserAvatar.textContent = '👤';
                }

                // Modal kapat
                closeProfile();
                showSuccess('Profil başarıyla güncellendi!', 'Başarılı!');

            } catch (error) {
                console.error('Profil kaydetme hatası:', error);
                showError('Profil kaydedilirken bir hata oluştu!');
            } finally {
                saveProfileBtn.textContent = 'Değişiklikleri Kaydet';
                saveProfileBtn.disabled = false;
            }
        }

        // Arkadaşları yükle
        async function loadFriends() {
            if (!currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const friends = userData.friends || [];
                    
                    // Arkadaş listesini temizle
                    friendsList.innerHTML = '';
                    
                    if (friends.length === 0) {
                        friendsList.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">Henüz arkadaşın yok.<br>Arkadaş ekle butonuna tıklayarak başla!</p>';
                        return;
                    }
                    
                    // Her arkadaş için bilgileri al ve listele
                    for (const friendId of friends) {
                        const friendDoc = await getDoc(doc(db, 'users', friendId));
                        if (friendDoc.exists()) {
                            const friendData = friendDoc.data();
                            addFriendToList(
                                friendId, 
                                friendData.displayName || friendData.name, 
                                friendData.username,
                                friendData.avatar // Avatar'ı da gönder
                            );
                        }
                    }
                }
            } catch (error) {
                console.error('Arkadaşlar yüklenirken hata:', error);
            }
        }

        // Arkadaş listesine ekle
        function addFriendToList(friendId, friendName, friendUsername, friendAvatar = null) {
            const friendItem = document.createElement('div');
            friendItem.className = 'friend-item';
            friendItem.dataset.friendId = friendId;
            
            const unreadCount = unreadMessages[friendId] || 0;
            const notificationBadge = unreadCount > 0 ? 
                `<div class="notification-badge">${unreadCount > 99 ? '99+' : unreadCount}</div>` : '';
            
            // Avatar HTML oluştur
            let avatarHTML;
            if (friendAvatar) {
                avatarHTML = `<div class="friend-avatar" style="background-image: url(${friendAvatar}); background-size: cover; background-position: center;"></div>`;
            } else {
                avatarHTML = `<div class="friend-avatar">👤</div>`;
            }
            
            friendItem.innerHTML = `
                ${avatarHTML}
                <div class="friend-info">
                    <div class="friend-name">${friendName}</div>
                    <div class="friend-status">@${friendUsername}</div>
                </div>
                ${notificationBadge}
            `;
            
            // Sol tık - sohbet aç
            friendItem.addEventListener('click', () => openChat(friendId, friendName));
            
            // Sağ tık - profil göster
            friendItem.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showFriendProfile(friendId);
            });
            
            // Çift tık - profil göster
            friendItem.addEventListener('dblclick', () => {
                showFriendProfile(friendId);
            });
            
            friendsList.appendChild(friendItem);
        }

        // Bildirim badge'ini güncelle
        function updateNotificationBadge(friendId, count) {
            const friendItem = document.querySelector(`[data-friend-id="${friendId}"]`);
            if (!friendItem) return;
            
            let badge = friendItem.querySelector('.notification-badge');
            
            if (count > 0) {
                if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'notification-badge';
                    friendItem.appendChild(badge);
                }
                badge.textContent = count > 99 ? '99+' : count;
            } else {
                if (badge) {
                    badge.remove();
                }
            }
        }

        // Tarayıcı bildirimi gönder
        function sendBrowserNotification(senderName, message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`${senderName} - BananaChat`, {
                    body: message,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">🍌</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">🍌</text></svg>'
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
                
                setTimeout(() => notification.close(), 5000);
            }
        }

        // Bildirim izni iste
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Arkadaş ekleme
        async function handleAddFriend() {
            let username = friendUsername.value.trim();
            
            if (!username) {
                showWarning('Lütfen kullanıcı adı girin!');
                return;
            }
            
            // @ işaretini kaldır
            if (username.startsWith('@')) {
                username = username.substring(1);
            }
            
            if (username === currentUserData.username) {
                showWarning('Kendini arkadaş olarak ekleyemezsin!');
                return;
            }
            
            try {
                sendFriendRequest.textContent = 'Gönderiliyor...';
                sendFriendRequest.disabled = true;
                
                // Kullanıcı adı ile kullanıcı ara
                const usersQuery = query(collection(db, 'users'), where('username', '==', username));
                const querySnapshot = await getDocs(usersQuery);
                
                if (querySnapshot.empty) {
                    showWarning('Bu kullanıcı adı ile kayıtlı kullanıcı bulunamadı!');
                    return;
                }
                
                const friendDoc = querySnapshot.docs[0];
                const friendData = friendDoc.data();
                const friendId = friendDoc.id;
                
                // Zaten arkadaş mı kontrol et
                const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const currentUserData = currentUserDoc.data();
                const currentFriends = currentUserData.friends || [];
                
                if (currentFriends.includes(friendId)) {
                    showInfo('Bu kullanıcı zaten arkadaşın!');
                    return;
                }

                // Engelli mi kontrol et
                const blockedUsers = currentUserData.blockedUsers || [];
                if (blockedUsers.includes(friendId)) {
                    showWarning('Bu kullanıcıyı engellemişsin!');
                    return;
                }

                // Arkadaş isteği gönder
                await addDoc(collection(db, 'friendRequests'), {
                    from: currentUser.uid,
                    to: friendId,
                    fromName: currentUser.displayName || 'Kullanıcı',
                    fromUsername: currentUserData.username,
                    fromAvatar: currentUserData.avatar,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                
                // Modal'ı kapat
                addFriendModal.classList.add('hidden');
                friendUsername.value = '';
                
                showSuccess(`@${friendData.username} kullanıcısına arkadaşlık isteği gönderildi!`, 'İstek Gönderildi!');
                
            } catch (error) {
                console.error('Arkadaş ekleme hatası:', error);
                showError('Arkadaş isteği gönderilirken bir hata oluştu!');
            } finally {
                sendFriendRequest.textContent = 'Arkadaşlık İsteği Gönder';
                sendFriendRequest.disabled = false;
            }
        }

        // Arkadaş isteklerini yükle
        async function loadFriendRequests() {
            if (!currentUser) return;
            
            try {
                const requestsQuery = query(
                    collection(db, 'friendRequests'),
                    where('to', '==', currentUser.uid),
                    where('status', '==', 'pending')
                );
                
                const querySnapshot = await getDocs(requestsQuery);
                friendRequests = [];
                friendRequestsList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    friendRequestsList.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Arkadaş isteğin yok</p>';
                    showRequestsBtn.textContent = '📬 İstekler';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const requestData = { id: doc.id, ...doc.data() };
                    friendRequests.push(requestData);
                    addFriendRequestToList(requestData);
                });
                
                // İstek sayısını göster
                showRequestsBtn.textContent = `📬 İstekler (${friendRequests.length})`;
                
            } catch (error) {
                console.error('Arkadaş istekleri yükleme hatası:', error);
            }
        }

        // Arkadaş isteğini listeye ekle
        function addFriendRequestToList(request) {
            const requestItem = document.createElement('div');
            requestItem.className = 'friend-request-item';
            
            let avatarHTML;
            if (request.fromAvatar) {
                avatarHTML = `<div class="friend-avatar" style="background-image: url(${request.fromAvatar}); background-size: cover; background-position: center;"></div>`;
            } else {
                avatarHTML = `<div class="friend-avatar">👤</div>`;
            }
            
            requestItem.innerHTML = `
                ${avatarHTML}
                <div class="friend-info">
                    <div class="friend-name">${request.fromName}</div>
                    <div class="friend-status">@${request.fromUsername}</div>
                </div>
                <div class="request-actions">
                    <button class="btn primary small" onclick="acceptFriendRequest('${request.id}', '${request.from}')">Kabul Et</button>
                    <button class="btn secondary small" onclick="rejectFriendRequest('${request.id}')">Reddet</button>
                </div>
            `;
            
            friendRequestsList.appendChild(requestItem);
        }

        // Arkadaş isteğini kabul et
        window.acceptFriendRequest = async function(requestId, fromUserId) {
            try {
                // İsteği güncelle
                await updateDoc(doc(db, 'friendRequests', requestId), {
                    status: 'accepted',
                    acceptedAt: serverTimestamp()
                });
                
                // Her iki kullanıcının da arkadaş listesine ekle
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    friends: arrayUnion(fromUserId)
                });
                
                await updateDoc(doc(db, 'users', fromUserId), {
                    friends: arrayUnion(currentUser.uid)
                });
                
                // Listeleri yenile
                await loadFriendRequests();
                await loadFriends();
                
                showSuccess('Arkadaşlık isteği kabul edildi!');
                
            } catch (error) {
                console.error('İstek kabul etme hatası:', error);
                showError('İstek kabul edilirken hata oluştu!');
            }
        };

        // Arkadaş isteğini reddet
        window.rejectFriendRequest = async function(requestId) {
            try {
                await updateDoc(doc(db, 'friendRequests', requestId), {
                    status: 'rejected',
                    rejectedAt: serverTimestamp()
                });
                
                await loadFriendRequests();
                showInfo('Arkadaşlık isteği reddedildi.');
                
            } catch (error) {
                console.error('İstek reddetme hatası:', error);
                showError('İstek reddedilirken hata oluştu!');
            }
        };

        // Engelleme sistemi
        async function blockUser(userId, userName) {
            const confirmed = await showConfirm(
                `${userName} kullanıcısını engellemek istediğinizden emin misiniz? Bu kullanıcı size mesaj gönderemeyecek ve sizi göremeyecek.`,
                'Kullanıcıyı Engelle'
            );

            if (!confirmed) return;

            try {
                // Engellenen kullanıcıyı listeye ekle
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    blockedUsers: arrayUnion(userId)
                });

                // Arkadaş listesinden çıkar
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    friends: currentUserData.friends.filter(id => id !== userId)
                });

                await updateDoc(doc(db, 'users', userId), {
                    friends: (await getDoc(doc(db, 'users', userId))).data().friends.filter(id => id !== currentUser.uid)
                });

                // Local data güncelle
                currentUserData.friends = currentUserData.friends.filter(id => id !== userId);
                if (!currentUserData.blockedUsers) {
                    currentUserData.blockedUsers = [];
                }
                currentUserData.blockedUsers.push(userId);

                // Buton metnini güncelle
                blockFriendBtn.textContent = '✅ Engeli Kaldır';
                blockFriendBtn.className = 'btn primary';
                blockFriendBtn.title = 'Bu kullanıcının engelini kaldır';

                // Kısa bir süre bekle ki kullanıcı değişikliği görebilsin
                setTimeout(() => {
                    // Modal'ı kapat ve listeyi yenile
                    friendProfileModal.classList.add('hidden');
                    loadFriends();
                }, 1000);

                showSuccess(`${userName} engellendi.`);

            } catch (error) {
                console.error('Engelleme hatası:', error);
                showError('Kullanıcı engellenirken hata oluştu!');
            }
        }

        // Engeli kaldır
        async function unblockUser(userId, userName) {
            const confirmed = await showConfirm(
                `${userName} kullanıcısının engelini kaldırmak istediğinizden emin misiniz?`,
                'Engeli Kaldır'
            );

            if (!confirmed) return;

            try {
                // Engellenen kullanıcıyı listeden çıkar
                const currentBlockedUsers = currentUserData.blockedUsers || [];
                const updatedBlockedUsers = currentBlockedUsers.filter(id => id !== userId);

                await updateDoc(doc(db, 'users', currentUser.uid), {
                    blockedUsers: updatedBlockedUsers
                });

                // Local data güncelle
                currentUserData.blockedUsers = updatedBlockedUsers;

                // Buton metnini güncelle
                blockFriendBtn.textContent = '🚫 Engelle';
                blockFriendBtn.className = 'btn secondary';
                blockFriendBtn.title = 'Bu kullanıcıyı engelle';

                showSuccess(`${userName} kullanıcısının engeli kaldırıldı.`);

            } catch (error) {
                console.error('Engel kaldırma hatası:', error);
                showError('Engel kaldırılırken hata oluştu!');
            }
        }

        // Sohbet aç
        async function openChat(friendId, friendName) {
            // Önceki mesaj dinleyicisini kapat
            if (messagesListener) {
                messagesListener();
            }
            
            // Aktif arkadaşı güncelle
            activeChatUser = { id: friendId, name: friendName };
            
            // Okunmamış mesajları sıfırla
            unreadMessages[friendId] = 0;
            updateNotificationBadge(friendId, 0);
            
            // UI güncelle
            document.querySelectorAll('.friend-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-friend-id="${friendId}"]`).classList.add('active');
            
            noChat.classList.add('hidden');
            activeChat.classList.remove('hidden');
            chatUserName.textContent = friendName;
            
            // Grup bilgilerini gizle (bireysel sohbet için)
            groupMembersSummary.classList.add('hidden');
            groupMembersPanel.classList.add('hidden');
            
            // Chat header'da arkadaşın avatar'ını göster
            try {
                const friendDoc = await getDoc(doc(db, 'users', friendId));
                if (friendDoc.exists()) {
                    const friendData = friendDoc.data();
                    const chatUserAvatar = document.querySelector('.chat-user-info .user-avatar');
                    if (friendData.avatar) {
                        chatUserAvatar.style.backgroundImage = `url(${friendData.avatar})`;
                        chatUserAvatar.textContent = '';
                    } else {
                        chatUserAvatar.style.backgroundImage = '';
                        chatUserAvatar.textContent = '👤';
                    }
                }
            } catch (error) {
                console.error('Arkadaş avatar yükleme hatası:', error);
            }
            
            // Mesajları yükle
            loadMessages(friendId);
            
            // Yazıyor göstergesini dinle
            listenToTyping();
        }

        // Mesajları yükle
        function loadMessages(friendId) {
            if (!currentUser) return;
            
            // Chat ID oluştur (küçük ID önce gelecek şekilde)
            const chatId = currentUser.uid < friendId ? 
                `${currentUser.uid}_${friendId}` : 
                `${friendId}_${currentUser.uid}`;
            
            // Mesajları dinle
            const messagesQuery = query(
                collection(db, 'chats', chatId, 'messages'),
                orderBy('timestamp', 'asc')
            );
            
            messagesListener = onSnapshot(messagesQuery, (snapshot) => {
                messagesContainer.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const message = { id: doc.id, ...doc.data() };
                    addMessageToChat(message);
                });
                
                // Okunmamış mesajları sıfırla (aktif chat için)
                if (unreadMessages[friendId]) {
                    unreadMessages[friendId] = 0;
                    updateNotificationBadge(friendId, 0);
                }
                
                // En alta kaydır
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
            
            // Tüm sohbetleri dinle (bildirimler için)
            listenToAllChats();
        }

        // Tüm sohbetleri dinle (bildirimler için)
        function listenToAllChats() {
            if (!currentUser || !currentUserData?.friends) return;
            
            currentUserData.friends.forEach(friendId => {
                const chatId = currentUser.uid < friendId ? 
                    `${currentUser.uid}_${friendId}` : 
                    `${friendId}_${currentUser.uid}`;
                
                const messagesQuery = query(
                    collection(db, 'chats', chatId, 'messages'),
                    orderBy('timestamp', 'desc')
                );
                
                onSnapshot(messagesQuery, async (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            
                            // Kendi mesajımız değilse ve aktif chat değilse bildirim gönder
                            if (message.senderId !== currentUser.uid && 
                                (!activeChatUser || activeChatUser.id !== message.senderId)) {
                                
                                // Okunmamış mesaj sayısını artır
                                if (!unreadMessages[message.senderId]) {
                                    unreadMessages[message.senderId] = 0;
                                }
                                unreadMessages[message.senderId]++;
                                
                                // Badge'i güncelle
                                updateNotificationBadge(message.senderId, unreadMessages[message.senderId]);
                                
                                // Gönderenin bilgilerini al
                                try {
                                    const senderDoc = await getDoc(doc(db, 'users', message.senderId));
                                    if (senderDoc.exists()) {
                                        const senderData = senderDoc.data();
                                        
                                        // Popup bildirim göster
                                        showNotificationPopup(
                                            senderData.displayName || senderData.name,
                                            message.text,
                                            senderData.avatar
                                        );
                                    }
                                } catch (error) {
                                    console.error('Gönderen bilgisi alma hatası:', error);
                                }
                                
                                // Tarayıcı bildirimi gönder
                                sendBrowserNotification(message.senderName, message.text);
                            }
                        }
                    });
                });
            });
        }

        // Mesajı chat'e ekle
        function addMessageToChat(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
            messageDiv.dataset.messageId = message.id || '';
            messageDiv.dataset.senderId = message.senderId;
            
            const timestamp = message.timestamp ? 
                new Date(message.timestamp.seconds * 1000).toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : '';
            
            // Mesaj silinmişse farklı görünüm
            if (message.deleted) {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-text message-deleted">Bu mesaj silindi</div>
                        <div class="message-time">${timestamp}</div>
                    </div>
                `;
            } else {
                // Mesaj aksiyonları (sadece kendi mesajlarımız için)
                const actionsHTML = message.senderId === currentUser.uid ? `
                    <div class="message-actions">
                        <button class="message-action-btn" title="Yanıtla" onclick="replyToMessage('${message.id}', '${message.senderId}', '${message.senderName}', '${message.text}')">
                            ↩️
                        </button>
                        <button class="message-action-btn delete" title="Mesajı Sil" onclick="deleteMessage('${message.id}', false)">
                            �️
                        </button>
                    </div>
                ` : `
                    <div class="message-actions">
                        <button class="message-action-btn" title="Yanıtla" onclick="replyToMessage('${message.id}', '${message.senderId}', '${message.senderName}', '${message.text}')">
                            ↩️
                        </button>
                    </div>
                `;
                
                // Yanıt HTML'i
                let replyHTML = '';
                if (message.replyTo) {
                    replyHTML = `
                        <div class="message-reply">
                            <div class="reply-author">${message.replyTo.senderName}</div>
                            <div class="reply-message">${message.replyTo.text}</div>
                        </div>
                    `;
                }
                
                // Mesaj içeriğini oluştur
                let messageContent;
                if (message.type === 'gif') {
                    messageContent = `<img src="${message.text}" alt="GIF" class="message-gif">`;
                } else if (message.type === 'image') {
                    messageContent = `<img src="${message.text}" alt="Resim" class="message-image" onclick="showImagePreview('${message.text}')">`;
                } else {
                    // Emoji'leri büyük göster (sadece emoji içeren mesajlar için)
                    const isOnlyEmojis = /^[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\s]*$/u.test(message.text);
                    if (isOnlyEmojis && message.text.length <= 10) {
                        messageContent = `<div class="message-text" style="font-size: 32px; line-height: 1.2;">${message.text}</div>`;
                    } else {
                        messageContent = `<div class="message-text">${message.text}</div>`;
                    }
                }
                
                // Okundu durumu
                const readStatus = message.senderId === currentUser.uid ? 
                    `<div class="message-status">
                        <span class="${message.read ? 'read-status' : 'unread-status'}">
                            ${message.read ? '✓✓' : '✓'}
                        </span>
                    </div>` : '';
                
                messageDiv.innerHTML = `
                    <div class="message-content">
                        ${replyHTML}
                        ${messageContent}
                        <div class="message-time">${timestamp}</div>
                        ${readStatus}
                    </div>
                    ${actionsHTML}
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
        }

        // Arkadaş profili göster
        async function showFriendProfile(friendId) {
            try {
                const friendDoc = await getDoc(doc(db, 'users', friendId));
                if (!friendDoc.exists()) {
                    showError('Arkadaş bilgileri bulunamadı!');
                    return;
                }

                const friendData = friendDoc.data();
                currentFriendProfile = { id: friendId, name: friendData.displayName || friendData.name };

                // Modal içeriğini doldur
                document.getElementById('friend-profile-title').textContent = `${friendData.displayName || friendData.name} - Profil`;
                friendProfileName.textContent = friendData.displayName || friendData.name;
                friendProfileUsername.textContent = `@${friendData.username}`;
                
                // Avatar
                if (friendData.avatar) {
                    friendProfileAvatar.style.backgroundImage = `url(${friendData.avatar})`;
                    friendProfileAvatar.textContent = '';
                } else {
                    friendProfileAvatar.style.backgroundImage = '';
                    friendProfileAvatar.textContent = '👤';
                }

                // Durum
                const statusText = getStatusText(friendData.status || 'online');
                friendProfileStatus.textContent = statusText;
                friendProfileStatus.className = `friend-profile-status ${friendData.status || 'online'}`;

                // Hakkında
                if (friendData.about && friendData.about.trim()) {
                    friendProfileAbout.textContent = friendData.about;
                    document.getElementById('friend-about-section').style.display = 'block';
                } else {
                    document.getElementById('friend-about-section').style.display = 'none';
                }

                // Engelleme durumunu kontrol et ve butonu güncelle
                const isBlocked = currentUserData.blockedUsers && currentUserData.blockedUsers.includes(friendId);
                if (isBlocked) {
                    blockFriendBtn.textContent = '✅ Engeli Kaldır';
                    blockFriendBtn.className = 'btn primary';
                    blockFriendBtn.title = 'Bu kullanıcının engelini kaldır';
                } else {
                    blockFriendBtn.textContent = '🚫 Engelle';
                    blockFriendBtn.className = 'btn secondary';
                    blockFriendBtn.title = 'Bu kullanıcıyı engelle';
                }

                // Modal'ı göster
                friendProfileModal.classList.remove('hidden');

            } catch (error) {
                console.error('Arkadaş profili yükleme hatası:', error);
                showError('Profil yüklenirken bir hata oluştu!');
            }
        }

        // Arkadaşlıktan çıkar
        async function handleRemoveFriend() {
            if (!currentFriendProfile) return;

            const confirmed = await showConfirm(
                `${currentFriendProfile.name} ile arkadaşlığınızı sonlandırmak istediğinizden emin misiniz?`,
                'Arkadaşlıktan Çıkar'
            );

            if (!confirmed) return;

            try {
                removeFriendBtn.textContent = 'Kaldırılıyor...';
                removeFriendBtn.disabled = true;

                // Her iki kullanıcının da arkadaş listesinden kaldır
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    friends: currentUserData.friends.filter(id => id !== currentFriendProfile.id)
                });

                await updateDoc(doc(db, 'users', currentFriendProfile.id), {
                    friends: (await getDoc(doc(db, 'users', currentFriendProfile.id))).data().friends.filter(id => id !== currentUser.uid)
                });

                // Local data güncelle
                currentUserData.friends = currentUserData.friends.filter(id => id !== currentFriendProfile.id);

                // Modal'ı kapat ve listeyi yenile
                friendProfileModal.classList.add('hidden');
                await loadFriends();

                showSuccess(`${currentFriendProfile.name} ile arkadaşlığınız sonlandırıldı.`);

            } catch (error) {
                console.error('Arkadaş kaldırma hatası:', error);
                showError('Arkadaş kaldırılırken bir hata oluştu!');
            } finally {
                removeFriendBtn.textContent = '❌ Arkadaşlıktan Çıkar';
                removeFriendBtn.disabled = false;
            }
        }

        // Grup oluşturma modal'ını aç
        async function openCreateGroupModal() {
            if (!currentUserData?.friends || currentUserData.friends.length === 0) {
                showWarning('Grup oluşturmak için en az bir arkadaşınız olmalı!');
                return;
            }

            // Arkadaş listesini doldur
            friendsSelection.innerHTML = '';
            
            for (const friendId of currentUserData.friends) {
                try {
                    const friendDoc = await getDoc(doc(db, 'users', friendId));
                    if (friendDoc.exists()) {
                        const friendData = friendDoc.data();
                        
                        const checkboxItem = document.createElement('div');
                        checkboxItem.className = 'friend-checkbox-item';
                        
                        let avatarHTML;
                        if (friendData.avatar) {
                            avatarHTML = `<div class="friend-checkbox-avatar" style="background-image: url(${friendData.avatar}); background-size: cover; background-position: center;"></div>`;
                        } else {
                            avatarHTML = `<div class="friend-checkbox-avatar">👤</div>`;
                        }
                        
                        checkboxItem.innerHTML = `
                            <input type="checkbox" id="friend-${friendId}" value="${friendId}">
                            ${avatarHTML}
                            <div class="friend-checkbox-info">
                                <div class="friend-checkbox-name">${friendData.displayName || friendData.name}</div>
                                <div class="friend-checkbox-username">@${friendData.username}</div>
                            </div>
                        `;
                        
                        checkboxItem.addEventListener('click', (e) => {
                            if (e.target.type !== 'checkbox') {
                                const checkbox = checkboxItem.querySelector('input[type="checkbox"]');
                                checkbox.checked = !checkbox.checked;
                            }
                        });
                        
                        friendsSelection.appendChild(checkboxItem);
                    }
                } catch (error) {
                    console.error('Arkadaş bilgisi yükleme hatası:', error);
                }
            }

            createGroupModal.classList.remove('hidden');
        }

        // Grup oluştur
        async function handleCreateGroup() {
            const name = groupName.value.trim();
            const description = groupDescription.value.trim();
            const selectedFriends = Array.from(friendsSelection.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

            if (!name) {
                showWarning('Grup adı boş olamaz!');
                return;
            }

            if (selectedFriends.length === 0) {
                showWarning('En az bir arkadaş seçmelisiniz!');
                return;
            }

            try {
                createGroupBtn.textContent = 'Oluşturuluyor...';
                createGroupBtn.disabled = true;

                // Grup oluştur
                const groupData = {
                    name: name,
                    description: description,
                    members: [currentUser.uid, ...selectedFriends],
                    admin: currentUser.uid,
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.displayName || 'Kullanıcı'
                };

                const groupRef = await addDoc(collection(db, 'groups'), groupData);

                // Modal'ı kapat
                createGroupModal.classList.add('hidden');
                groupName.value = '';
                groupDescription.value = '';

                showSuccess(`"${name}" grubu başarıyla oluşturuldu!`);

                // Grup listesini yenile
                await loadGroups();

            } catch (error) {
                console.error('Grup oluşturma hatası:', error);
                showError('Grup oluşturulurken bir hata oluştu!');
            } finally {
                createGroupBtn.textContent = 'Grup Oluştur';
                createGroupBtn.disabled = false;
            }
        }

        // Grupları yükle
        async function loadGroups() {
            if (!currentUser) return;
            
            try {
                console.log('Gruplar yükleniyor...');
                
                // Kullanıcının üye olduğu grupları bul
                const groupsQuery = query(
                    collection(db, 'groups'), 
                    where('members', 'array-contains', currentUser.uid)
                );
                
                const querySnapshot = await getDocs(groupsQuery);
                userGroups = [];
                
                const groupsList = document.getElementById('groups-list');
                groupsList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    groupsList.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px; font-size: 14px;">Henüz hiçbir grubun yok.<br>Grup oluştur butonuna tıklayarak başla!</p>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const groupData = doc.data();
                    const groupId = doc.id;
                    
                    userGroups.push({
                        id: groupId,
                        ...groupData
                    });
                    
                    addGroupToList(groupId, groupData);
                });
                
                console.log('Gruplar yüklendi:', userGroups);
                
            } catch (error) {
                console.error('Gruplar yüklenirken hata:', error);
                const groupsList = document.getElementById('groups-list');
                groupsList.innerHTML = '<p style="text-align: center; color: #f56565; padding: 20px; font-size: 14px;">Gruplar yüklenirken hata oluştu!</p>';
            }
        }

        // Grup listesine ekle
        function addGroupToList(groupId, groupData) {
            const groupsList = document.getElementById('groups-list');
            
            const groupItem = document.createElement('div');
            groupItem.className = 'friend-item'; // Aynı stil kullan
            groupItem.dataset.groupId = groupId;
            
            // Grup üye sayısını hesapla
            const memberCount = groupData.members ? groupData.members.length : 0;
            
            groupItem.innerHTML = `
                <div class="friend-avatar">👥</div>
                <div class="friend-info">
                    <div class="friend-name">${groupData.name}</div>
                    <div class="friend-status">${memberCount} üye</div>
                </div>
            `;
            
            // Grup sohbetini aç
            groupItem.addEventListener('click', () => openGroupChat(groupId, groupData.name));
            
            groupsList.appendChild(groupItem);
        }

        // Grup sohbetini aç
        async function openGroupChat(groupId, groupName) {
            // Önceki mesaj dinleyicisini kapat
            if (messagesListener) {
                messagesListener();
            }
            
            // Aktif grup sohbetini güncelle
            activeChatUser = { id: groupId, name: groupName, isGroup: true };
            
            // UI güncelle
            document.querySelectorAll('.friend-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-group-id="${groupId}"]`).classList.add('active');
            
            noChat.classList.add('hidden');
            activeChat.classList.remove('hidden');
            chatUserName.textContent = groupName;
            
            // Grup bilgilerini göster
            groupMembersSummary.classList.remove('hidden');
            
            // Chat header'da grup ikonu göster
            const chatUserAvatar = document.querySelector('.chat-user-info .user-avatar');
            chatUserAvatar.style.backgroundImage = '';
            chatUserAvatar.textContent = '👥';
            
            // Grup üyelerini yükle ve göster
            await loadGroupMembers(groupId);
            
            // Grup mesajlarını yükle
            loadGroupMessages(groupId);
            
            // Yazıyor göstergesini dinle
            listenToTyping();
        }

        // Grup mesajlarını yükle
        function loadGroupMessages(groupId) {
            if (!currentUser) return;
            
            // Grup mesajlarını dinle
            const messagesQuery = query(
                collection(db, 'groups', groupId, 'messages'),
                orderBy('timestamp', 'asc')
            );
            
            messagesListener = onSnapshot(messagesQuery, (snapshot) => {
                messagesContainer.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const message = { id: doc.id, ...doc.data() };
                    addGroupMessageToChat(message);
                });
                
                // En alta kaydır
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        // Grup mesajını chat'e ekle
        function addGroupMessageToChat(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
            messageDiv.dataset.messageId = message.id || '';
            messageDiv.dataset.senderId = message.senderId;
            
            const timestamp = message.timestamp ? 
                new Date(message.timestamp.seconds * 1000).toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : '';
            
            // Grup mesajlarında gönderen adını göster
            const senderName = message.senderId === currentUser.uid ? 'Sen' : message.senderName;
            
            // Mesaj silinmişse farklı görünüm
            if (message.deleted) {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-sender">${senderName}</div>
                        <div class="message-text message-deleted">Bu mesaj silindi</div>
                        <div class="message-time">${timestamp}</div>
                    </div>
                `;
            } else {
                // Mesaj aksiyonları (sadece kendi mesajlarımız için)
                const actionsHTML = message.senderId === currentUser.uid ? `
                    <div class="message-actions">
                        <button class="message-action-btn delete" title="Mesajı Sil" onclick="deleteMessage('${message.id}', true)">
                            🗑️
                        </button>
                    </div>
                ` : '';
                
                // Mesaj içeriğini oluştur
                let messageContent;
                if (message.type === 'gif') {
                    messageContent = `<img src="${message.text}" alt="GIF" class="message-gif">`;
                } else if (message.type === 'image') {
                    messageContent = `<img src="${message.text}" alt="Resim" class="message-image" onclick="showImagePreview('${message.text}')">`;
                } else {
                    // Emoji'leri büyük göster (sadece emoji içeren mesajlar için)
                    const isOnlyEmojis = /^[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\s]*$/u.test(message.text);
                    if (isOnlyEmojis && message.text.length <= 10) {
                        messageContent = `<div class="message-text" style="font-size: 32px; line-height: 1.2;">${message.text}</div>`;
                    } else {
                        messageContent = `<div class="message-text">${message.text}</div>`;
                    }
                }
                
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-sender">${senderName}</div>
                        ${messageContent}
                        <div class="message-time">${timestamp}</div>
                    </div>
                    ${actionsHTML}
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
        }

        // Mesaj gönder (güncellenmiş versiyon - grup desteği ile)
        async function sendMessage() {
            const text = messageInput.value.trim();
            
            if (!text || !activeChatUser) return;
            
            try {
                const messageData = {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || 'Kullanıcı',
                    timestamp: serverTimestamp(),
                    type: 'text', // Mesaj tipi
                    read: false // Okundu durumu
                };

                // Yanıt varsa ekle
                if (replyingTo) {
                    messageData.replyTo = {
                        messageId: replyingTo.id,
                        senderId: replyingTo.senderId,
                        senderName: replyingTo.senderName,
                        text: replyingTo.text
                    };
                }

                if (activeChatUser.isGroup) {
                    // Grup mesajı gönder
                    await addDoc(collection(db, 'groups', activeChatUser.id, 'messages'), messageData);
                } else {
                    // Bireysel mesaj gönder
                    const chatId = currentUser.uid < activeChatUser.id ? 
                        `${currentUser.uid}_${activeChatUser.id}` : 
                        `${activeChatUser.id}_${currentUser.uid}`;
                    
                    await addDoc(collection(db, 'chats', chatId, 'messages'), messageData);
                }
                
                // Input'u temizle ve yanıtı iptal et
                messageInput.value = '';
                if (replyingTo) {
                    cancelReplyMessage();
                }
                
                // Yazıyor durumunu kapat
                sendTypingStatus(false);
                
                // Gönderme animasyonu
                showMessageSentAnimation();
                
            } catch (error) {
                console.error('Mesaj gönderme hatası:', error);
                showError('Mesaj gönderilemedi!');
            }
        }

        // GIF mesajı gönder
        async function sendGifMessage(gifUrl) {
            if (!activeChatUser) return;
            
            try {
                const messageData = {
                    text: gifUrl,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || 'Kullanıcı',
                    timestamp: serverTimestamp(),
                    type: 'gif' // GIF mesajı
                };

                if (activeChatUser.isGroup) {
                    // Grup GIF mesajı gönder
                    await addDoc(collection(db, 'groups', activeChatUser.id, 'messages'), messageData);
                } else {
                    // Bireysel GIF mesajı gönder
                    const chatId = currentUser.uid < activeChatUser.id ? 
                        `${currentUser.uid}_${activeChatUser.id}` : 
                        `${activeChatUser.id}_${currentUser.uid}`;
                    
                    await addDoc(collection(db, 'chats', chatId, 'messages'), messageData);
                }
                
            } catch (error) {
                console.error('GIF gönderme hatası:', error);
                showError('GIF gönderilemedi!');
            }
        }

        // Grup üyelerini yükle
        async function loadGroupMembers(groupId) {
            try {
                console.log('Grup üyeleri yükleniyor...', groupId);
                
                // Grup bilgilerini al
                const groupDoc = await getDoc(doc(db, 'groups', groupId));
                if (!groupDoc.exists()) {
                    console.error('Grup bulunamadı!');
                    return;
                }
                
                const groupData = groupDoc.data();
                const memberIds = groupData.members || [];
                
                console.log('Grup üye ID\'leri:', memberIds);
                
                // Üye bilgilerini al
                const members = [];
                let onlineMembers = 0;
                
                for (const memberId of memberIds) {
                    try {
                        const memberDoc = await getDoc(doc(db, 'users', memberId));
                        if (memberDoc.exists()) {
                            const memberData = memberDoc.data();
                            const isOnline = await checkUserOnlineStatus(memberId);
                            
                            members.push({
                                id: memberId,
                                ...memberData,
                                isOnline: isOnline,
                                isAdmin: memberId === groupData.admin
                            });
                            
                            if (isOnline) onlineMembers++;
                        }
                    } catch (error) {
                        console.error('Üye bilgisi yükleme hatası:', error);
                    }
                }
                
                console.log('Yüklenen üyeler:', members);
                
                // UI güncelle
                membersCount.textContent = `${members.length} üye`;
                onlineCount.textContent = `${onlineMembers} çevrimiçi`;
                
                // Üye listesini göster
                displayGroupMembers(members);
                
            } catch (error) {
                console.error('Grup üyeleri yükleme hatası:', error);
                membersCount.textContent = 'Hata';
                onlineCount.textContent = '';
            }
        }

        // Kullanıcının çevrimiçi durumunu kontrol et
        async function checkUserOnlineStatus(userId) {
            try {
                // Basit bir çevrimiçi kontrolü - gerçek uygulamada presence sistemi kullanılır
                // Şimdilik kullanıcının status'üne bakıyoruz
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    // Status 'invisible' değilse çevrimiçi sayıyoruz
                    return userData.status !== 'invisible';
                }
                return false;
            } catch (error) {
                console.error('Çevrimiçi durum kontrolü hatası:', error);
                return false;
            }
        }

        // Grup üyelerini göster
        function displayGroupMembers(members) {
            membersList.innerHTML = '';
            
            if (members.length === 0) {
                membersList.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Üye bulunamadı</p>';
                return;
            }
            
            // Önce admin'i, sonra çevrimiçi olanları, sonra çevrimdışı olanları göster
            members.sort((a, b) => {
                if (a.isAdmin && !b.isAdmin) return -1;
                if (!a.isAdmin && b.isAdmin) return 1;
                if (a.isOnline && !b.isOnline) return -1;
                if (!a.isOnline && b.isOnline) return 1;
                return a.displayName?.localeCompare(b.displayName) || 0;
            });
            
            members.forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                
                // Avatar HTML
                let avatarHTML;
                if (member.avatar) {
                    avatarHTML = `<div class="member-avatar" style="background-image: url(${member.avatar}); background-size: cover; background-position: center;">`;
                } else {
                    avatarHTML = `<div class="member-avatar">👤`;
                }
                
                // Durum göstergesi
                const statusClass = member.isOnline ? (member.status || 'online') : 'offline';
                avatarHTML += `<div class="member-status-indicator ${statusClass}"></div></div>`;
                
                // Rol badge'i
                const roleHTML = member.isAdmin ? '<span class="member-role">Admin</span>' : '';
                
                memberItem.innerHTML = `
                    ${avatarHTML}
                    <div class="member-info">
                        <div class="member-name">${member.displayName || member.name || 'Kullanıcı'}</div>
                        <div class="member-username">@${member.username || 'kullanici'}</div>
                    </div>
                    ${roleHTML}
                `;
                
                // Üyeye tıklayınca profil göster (kendi profilimiz değilse)
                if (member.id !== currentUser.uid) {
                    memberItem.style.cursor = 'pointer';
                    memberItem.addEventListener('click', () => {
                        groupMembersPanel.classList.add('hidden');
                        showFriendProfile(member.id);
                    });
                }
                
                membersList.appendChild(memberItem);
            });
        }

        // Emoji/GIF panelini aç/kapat
        function toggleEmojiGifPanel(type) {
            const isHidden = emojiGifPanel.classList.contains('hidden');
            
            if (isHidden) {
                emojiGifPanel.classList.remove('hidden');
                switchTab(type);
                if (type === 'emoji') {
                    loadEmojis();
                } else {
                    loadTrendingGifs();
                }
            } else {
                emojiGifPanel.classList.add('hidden');
            }
        }

        // Panel tab'ları arasında geçiş
        function switchTab(type) {
            // Tab butonlarını güncelle
            emojiTab.classList.toggle('active', type === 'emoji');
            gifTab.classList.toggle('active', type === 'gif');
            
            // İçerikleri göster/gizle
            emojiContent.classList.toggle('hidden', type !== 'emoji');
            gifContent.classList.toggle('hidden', type !== 'gif');
        }

        // Emojileri yükle
        function loadEmojis() {
            if (emojiGrid.children.length > 0) return; // Zaten yüklenmişse
            
            // Popüler emojiler listesi
            const emojis = [
                '😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣',
                '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰',
                '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜',
                '🤪', '🤨', '🧐', '🤓', '😎', '🤩', '🥳', '😏',
                '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣',
                '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠',
                '😡', '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨',
                '😰', '😥', '😓', '🤗', '🤔', '🤭', '🤫', '🤥',
                '😶', '😐', '😑', '😬', '🙄', '😯', '😦', '😧',
                '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐',
                '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕', '🤑',
                '🤠', '😈', '👿', '👹', '👺', '🤡', '💩', '👻',
                '💀', '☠️', '👽', '👾', '🤖', '🎃', '😺', '😸',
                '😹', '😻', '😼', '😽', '🙀', '😿', '😾', '❤️',
                '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎',
                '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💘',
                '💝', '💟', '☮️', '✝️', '☪️', '🕉️', '☸️', '✡️',
                '🔯', '🕎', '☯️', '☦️', '🛐', '⛎', '♈', '♉',
                '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑',
                '♒', '♓', '🆔', '⚛️', '🉑', '☢️', '☣️', '📴',
                '📳', '🈶', '🈚', '🈸', '🈺', '🈷️', '✴️', '🆚',
                '💮', '🉐', '㊙️', '㊗️', '🈴', '🈵', '🈹', '🈲',
                '🅰️', '🅱️', '🆎', '🆑', '🅾️', '🆘', '❌', '⭕',
                '🛑', '⛔', '📛', '🚫', '💯', '💢', '♨️', '🚷',
                '🚯', '🚳', '🚱', '🔞', '📵', '🚭', '❗', '❕',
                '❓', '❔', '‼️', '⁉️', '🔅', '🔆', '〽️', '⚠️',
                '🚸', '🔱', '⚜️', '🔰', '♻️', '✅', '🈯', '💹',
                '❇️', '✳️', '❎', '🌐', '💠', 'Ⓜ️', '🌀', '💤',
                '🏧', '🚾', '♿', '🅿️', '🈳', '🈂️', '🛂', '🛃',
                '🛄', '🛅', '🚹', '🚺', '🚼', '🚻', '🚮', '🎦',
                '📶', '🈁', '🔣', 'ℹ️', '🔤', '🔡', '🔠', '🆖',
                '🆗', '🆙', '🆒', '🆕', '🆓', '0️⃣', '1️⃣', '2️⃣',
                '3️⃣', '4️⃣', '5️⃣', '6️⃣', '7️⃣', '8️⃣', '9️⃣', '🔟'
            ];
            
            emojis.forEach(emoji => {
                const emojiItem = document.createElement('button');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.addEventListener('click', () => insertEmoji(emoji));
                emojiGrid.appendChild(emojiItem);
            });
        }

        // Emoji ekle
        function insertEmoji(emoji) {
            const currentValue = messageInput.value;
            const cursorPos = messageInput.selectionStart;
            const newValue = currentValue.slice(0, cursorPos) + emoji + currentValue.slice(cursorPos);
            
            messageInput.value = newValue;
            messageInput.focus();
            
            // Cursor pozisyonunu emoji'den sonraya ayarla
            const newCursorPos = cursorPos + emoji.length;
            messageInput.setSelectionRange(newCursorPos, newCursorPos);
        }

        // Trending GIF'leri yükle
        async function loadTrendingGifs() {
            if (gifGrid.children.length > 0) return; // Zaten yüklenmişse
            
            gifGrid.innerHTML = '<div class="gif-loading">Popüler GIF\'ler yükleniyor...</div>';
            
            try {
                // Giphy API kullanarak trending GIF'leri al
                const response = await fetch('https://api.giphy.com/v1/gifs/trending?api_key=GlVGYHkr3WSBnllca54iNt0yFbjz7L65&limit=20&rating=g');
                const data = await response.json();
                
                gifGrid.innerHTML = '';
                
                data.data.forEach(gif => {
                    const gifItem = document.createElement('button');
                    gifItem.className = 'gif-item';
                    gifItem.innerHTML = `<img src="${gif.images.fixed_height_small.url}" alt="${gif.title}">`;
                    gifItem.addEventListener('click', () => insertGif(gif.images.fixed_height.url));
                    gifGrid.appendChild(gifItem);
                });
                
            } catch (error) {
                console.error('GIF yükleme hatası:', error);
                gifGrid.innerHTML = '<div class="gif-loading">GIF\'ler yüklenemedi</div>';
            }
        }

        // GIF ara
        async function searchGifs() {
            const query = gifSearchInput.value.trim();
            
            if (!query) {
                loadTrendingGifs();
                return;
            }
            
            gifGrid.innerHTML = '<div class="gif-loading">GIF\'ler aranıyor...</div>';
            
            try {
                const response = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=GlVGYHkr3WSBnllca54iNt0yFbjz7L65&q=${encodeURIComponent(query)}&limit=20&rating=g`);
                const data = await response.json();
                
                gifGrid.innerHTML = '';
                
                if (data.data.length === 0) {
                    gifGrid.innerHTML = '<div class="gif-loading">GIF bulunamadı</div>';
                    return;
                }
                
                data.data.forEach(gif => {
                    const gifItem = document.createElement('button');
                    gifItem.className = 'gif-item';
                    gifItem.innerHTML = `<img src="${gif.images.fixed_height_small.url}" alt="${gif.title}">`;
                    gifItem.addEventListener('click', () => insertGif(gif.images.fixed_height.url));
                    gifGrid.appendChild(gifItem);
                });
                
            } catch (error) {
                console.error('GIF arama hatası:', error);
                gifGrid.innerHTML = '<div class="gif-loading">GIF arama hatası</div>';
            }
        }

        // GIF ekle
        function insertGif(gifUrl) {
            // GIF'i mesaj olarak gönder
            sendGifMessage(gifUrl);
            emojiGifPanel.classList.add('hidden');
        }

        // Debounce fonksiyonu
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Resim upload işlemi
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Dosya boyutu kontrolü (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showWarning('Resim boyutu 5MB\'dan küçük olmalıdır!');
                return;
            }

            // Dosya tipi kontrolü
            if (!file.type.startsWith('image/')) {
                showWarning('Sadece resim dosyaları yükleyebilirsiniz!');
                return;
            }

            try {
                // Yükleme durumunu göster
                imageBtn.classList.add('image-uploading');
                imageBtn.innerHTML = '⏳';

                // Base64'e çevir
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    
                    // Resmi mesaj olarak gönder
                    sendImageMessage(base64Image);
                    
                    // Input'u temizle
                    imageUploadInput.value = '';
                    
                    // Yükleme durumunu kaldır
                    imageBtn.classList.remove('image-uploading');
                    imageBtn.innerHTML = '📷';
                };
                
                reader.onerror = function() {
                    showError('Resim okuma hatası!');
                    imageBtn.classList.remove('image-uploading');
                    imageBtn.innerHTML = '📷';
                };
                
                reader.readAsDataURL(file);

            } catch (error) {
                console.error('Resim yükleme hatası:', error);
                showError('Resim yüklenirken bir hata oluştu!');
                imageBtn.classList.remove('image-uploading');
                imageBtn.innerHTML = '📷';
            }
        }

        // Resim mesajı gönder
        async function sendImageMessage(imageData) {
            if (!activeChatUser) return;
            
            try {
                const messageData = {
                    text: imageData,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || 'Kullanıcı',
                    timestamp: serverTimestamp(),
                    type: 'image' // Resim mesajı
                };

                if (activeChatUser.isGroup) {
                    // Grup resim mesajı gönder
                    await addDoc(collection(db, 'groups', activeChatUser.id, 'messages'), messageData);
                } else {
                    // Bireysel resim mesajı gönder
                    const chatId = currentUser.uid < activeChatUser.id ? 
                        `${currentUser.uid}_${activeChatUser.id}` : 
                        `${activeChatUser.id}_${currentUser.uid}`;
                    
                    await addDoc(collection(db, 'chats', chatId, 'messages'), messageData);
                }
                
            } catch (error) {
                console.error('Resim gönderme hatası:', error);
                showError('Resim gönderilemedi!');
            }
        }

        // Resim önizleme göster
        function showImagePreview(imageSrc) {
            imagePreviewImg.src = imageSrc;
            imagePreviewModal.classList.remove('hidden');
        }

        // Yazıyor göstergesi
        function handleTyping() {
            if (!activeChatUser || !currentUser) return;
            
            // Yazıyor durumunu Firestore'a gönder
            sendTypingStatus(true);
            
            // Önceki timeout'u temizle
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // 3 saniye sonra yazıyor durumunu kapat
            typingTimeout = setTimeout(() => {
                sendTypingStatus(false);
            }, 3000);
        }

        async function sendTypingStatus(isTyping) {
            if (!activeChatUser || !currentUser) return;
            
            try {
                let docRef;
                if (activeChatUser.isGroup) {
                    docRef = doc(db, 'groups', activeChatUser.id, 'typing', currentUser.uid);
                } else {
                    const chatId = currentUser.uid < activeChatUser.id ? 
                        `${currentUser.uid}_${activeChatUser.id}` : 
                        `${activeChatUser.id}_${currentUser.uid}`;
                    docRef = doc(db, 'chats', chatId, 'typing', currentUser.uid);
                }
                
                if (isTyping) {
                    await setDoc(docRef, {
                        userId: currentUser.uid,
                        userName: currentUser.displayName || 'Kullanıcı',
                        timestamp: serverTimestamp()
                    });
                } else {
                    await deleteDoc(docRef);
                }
            } catch (error) {
                console.error('Yazıyor durumu gönderme hatası:', error);
            }
        }

        // Yazıyor göstergesi fonksiyonları
        function listenToTyping() {
            if (!activeChatUser || !currentUser) return;
            
            let typingRef;
            if (activeChatUser.isGroup) {
                typingRef = collection(db, 'groups', activeChatUser.id, 'typing');
            } else {
                const chatId = currentUser.uid < activeChatUser.id ? 
                    `${currentUser.uid}_${activeChatUser.id}` : 
                    `${activeChatUser.id}_${currentUser.uid}`;
                typingRef = collection(db, 'chats', chatId, 'typing');
            }
            
            onSnapshot(typingRef, (snapshot) => {
                const typingUsers = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.userId !== currentUser.uid) {
                        typingUsers.push(data.userName);
                    }
                });
                
                if (typingUsers.length > 0) {
                    typingUser.textContent = typingUsers.join(', ');
                    typingIndicator.classList.remove('hidden');
                } else {
                    typingIndicator.classList.add('hidden');
                }
            });
        }

        // Mesaj yanıtlama fonksiyonları
        window.replyToMessage = function(messageId, senderId, senderName, messageText) {
            replyingTo = {
                id: messageId,
                senderId: senderId,
                senderName: senderName,
                text: messageText
            };
            
            replyAuthor.textContent = senderName;
            replyText.textContent = messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText;
            replyPreview.classList.remove('hidden');
            
            messageInput.focus();
        };

        function cancelReplyMessage() {
            replyingTo = null;
            replyPreview.classList.add('hidden');
        }

        // Mesaj sabitleme fonksiyonları - KALDIRILDI
        // window.pinMessage = async function(messageId, messageText) { ... }

        // Bildirim animasyonları
        function showNotificationPopup(title, message, avatar = null) {
            // Önceki bildirimi kapat
            notificationPopup.classList.add('hidden');
            
            // Yeni bildirim içeriği
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            if (avatar) {
                notificationAvatar.style.backgroundImage = `url(${avatar})`;
                notificationAvatar.textContent = '';
            } else {
                notificationAvatar.style.backgroundImage = '';
                notificationAvatar.textContent = '👤';
            }
            
            // Bildirimi göster
            notificationPopup.classList.remove('hidden');
            
            // 4 saniye sonra otomatik kapat
            setTimeout(() => {
                notificationPopup.classList.add('hidden');
            }, 4000);
        }

        // Mesaj gönderme animasyonu
        function showMessageSentAnimation() {
            const sendButton = document.getElementById('send-btn');
            const originalText = sendButton.textContent;
            
            sendButton.textContent = '✓';
            sendButton.style.background = '#48bb78';
            
            setTimeout(() => {
                sendButton.textContent = originalText;
                sendButton.style.background = '';
            }, 1000);
        }

        // Banner upload işlemi
        async function handleBannerUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Dosya boyutu kontrolü (3MB)
            if (file.size > 3 * 1024 * 1024) {
                showWarning('Banner boyutu 3MB\'dan küçük olmalıdır!');
                return;
            }

            // Dosya tipi kontrolü
            if (!file.type.startsWith('image/')) {
                showWarning('Sadece resim dosyaları yükleyebilirsiniz!');
                return;
            }

            try {
                uploadBannerBtn.textContent = 'Yükleniyor...';
                uploadBannerBtn.disabled = true;

                // Base64'e çevir
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    
                    // Banner'ı güncelle
                    profileBanner.style.backgroundImage = `url(${base64Image})`;

                    // Geçici olarak currentUserData'yı güncelle
                    currentUserData.banner = base64Image;
                    
                    uploadBannerBtn.textContent = 'Banner Yükle';
                    uploadBannerBtn.disabled = false;
                    
                    showSuccess('Banner başarıyla yüklendi!');
                };
                
                reader.onerror = function() {
                    showError('Dosya okuma hatası!');
                    uploadBannerBtn.textContent = 'Banner Yükle';
                    uploadBannerBtn.disabled = false;
                };
                
                reader.readAsDataURL(file);

            } catch (error) {
                console.error('Banner yükleme hatası:', error);
                showError('Banner yüklenirken bir hata oluştu!');
                uploadBannerBtn.textContent = 'Banner Yükle';
                uploadBannerBtn.disabled = false;
            }
        }

        // Banner kaldır
        async function removeBanner() {
            try {
                // UI'dan kaldır
                profileBanner.style.backgroundImage = '';

                // Geçici olarak currentUserData'yı güncelle
                currentUserData.banner = null;
                
                showSuccess('Banner kaldırıldı!');

            } catch (error) {
                console.error('Banner kaldırma hatası:', error);
                // Hata olsa bile UI'dan kaldır
                profileBanner.style.backgroundImage = '';
                currentUserData.banner = null;
            }
        }

        // Engellenen kullanıcıları yükle
        async function loadBlockedUsers() {
            if (!currentUserData || !currentUserData.blockedUsers) {
                blockedUsersList.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Engellenen kullanıcı yok</p>';
                return;
            }

            try {
                blockedUsersList.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 10px;">Yükleniyor...</p>';
                
                if (currentUserData.blockedUsers.length === 0) {
                    blockedUsersList.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Engellenen kullanıcı yok</p>';
                    return;
                }

                blockedUsersList.innerHTML = '';

                for (const blockedUserId of currentUserData.blockedUsers) {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', blockedUserId));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            addBlockedUserToList(blockedUserId, userData);
                        }
                    } catch (error) {
                        console.error('Engellenen kullanıcı bilgisi yükleme hatası:', error);
                    }
                }

            } catch (error) {
                console.error('Engellenen kullanıcılar yükleme hatası:', error);
                blockedUsersList.innerHTML = '<p style="text-align: center; color: #f56565; padding: 20px;">Yükleme hatası</p>';
            }
        }

        // Engellenen kullanıcıyı listeye ekle
        function addBlockedUserToList(userId, userData) {
            const blockedUserItem = document.createElement('div');
            blockedUserItem.className = 'blocked-user-item';
            blockedUserItem.dataset.userId = userId;

            let avatarHTML;
            if (userData.avatar) {
                avatarHTML = `<div class="blocked-user-avatar" style="background-image: url(${userData.avatar}); background-size: cover; background-position: center;"></div>`;
            } else {
                avatarHTML = `<div class="blocked-user-avatar">👤</div>`;
            }

            blockedUserItem.innerHTML = `
                ${avatarHTML}
                <div class="blocked-user-info">
                    <div class="blocked-user-name">${userData.displayName || userData.name || 'Kullanıcı'}</div>
                    <div class="blocked-user-username">@${userData.username || 'kullanici'}</div>
                </div>
                <button class="unblock-btn" onclick="unblockUserFromProfile('${userId}', '${userData.displayName || userData.name}')">
                    Engeli Kaldır
                </button>
            `;

            blockedUsersList.appendChild(blockedUserItem);
        }

        // Profil modalından engel kaldır
        window.unblockUserFromProfile = async function(userId, userName) {
            try {
                const confirmed = await showConfirm(
                    `${userName} kullanıcısının engelini kaldırmak istediğinizden emin misiniz?`,
                    'Engeli Kaldır'
                );

                if (!confirmed) return;

                // Engellenen kullanıcıyı listeden çıkar
                const currentBlockedUsers = currentUserData.blockedUsers || [];
                const updatedBlockedUsers = currentBlockedUsers.filter(id => id !== userId);

                await updateDoc(doc(db, 'users', currentUser.uid), {
                    blockedUsers: updatedBlockedUsers
                });

                // Local data güncelle
                currentUserData.blockedUsers = updatedBlockedUsers;

                // UI'dan kaldır
                const userItem = document.querySelector(`[data-user-id="${userId}"]`);
                if (userItem) {
                    userItem.remove();
                }

                // Liste boşsa mesaj göster
                if (updatedBlockedUsers.length === 0) {
                    blockedUsersList.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Engellenen kullanıcı yok</p>';
                }

                showSuccess(`${userName} kullanıcısının engeli kaldırıldı.`);

            } catch (error) {
                console.error('Engel kaldırma hatası:', error);
                showError('Engel kaldırılırken hata oluştu!');
            }
        };
    </script>
</body>
</html>